<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>World Income Inequality — Level & Change</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Source+Sans+3:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
:root {
  --bg: #F9F9F6;
  --surface: #FFFFFF;
  --surface-alt: #F3F2EE;
  --border: #DAD8D0;
  --border-light: #ECEAE4;
  --text: #222220;
  --text-mid: #555550;
  --text-light: #888882;
  --text-faint: #ABAAA2;
  --accent: #BA3A1E;
  --accent-light: #E8D5CF;

  /* Region palette — tested for WCAG AA on white */
  --c-eap: #3B6D8F;
  --c-eca: #3A8660;
  --c-lac: #C44536;
  --c-mena: #C47F17;
  --c-na: #5A8E8A;
  --c-sa: #8856A7;
  --c-ssa: #B8860B;

  /* Quadrant fills */
  --q-green: #E6F2EC;
  --q-yellow: #FFF6E0;
  --q-red: #FCEAE8;
  --q-blue: #E8F0F8;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Source Sans 3', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

.page {
  max-width: 1200px;
  margin: 0 auto;
  padding: 40px 36px 80px;
}

/* === HEADER === */
.header {
  margin-bottom: 32px;
}
.header .kicker {
  font-size: 0.78rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--accent);
  margin-bottom: 8px;
}
.header h1 {
  font-family: 'Playfair Display', Georgia, serif;
  font-weight: 800;
  font-size: 1.85rem;
  line-height: 1.2;
  color: var(--text);
  max-width: 800px;
  letter-spacing: -0.01em;
}
.header .dek {
  font-size: 1.05rem;
  font-weight: 300;
  color: var(--text-mid);
  margin-top: 8px;
  max-width: 720px;
  line-height: 1.55;
}
.header .divider {
  width: 100%;
  height: 3px;
  background: var(--text);
  margin-top: 16px;
}

/* === CONTROLS === */
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: flex-end;
  margin-bottom: 12px;
  padding: 16px 20px;
  background: var(--surface);
  border: 1px solid var(--border-light);
  border-radius: 6px;
}
.ctrl {
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.ctrl label {
  font-size: 0.68rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-faint);
}
.ctrl select, .ctrl input[type="text"], .ctrl input[type="number"] {
  font-family: 'Source Sans 3', sans-serif;
  font-size: 0.84rem;
  padding: 5px 10px;
  border: 1.5px solid var(--border);
  border-radius: 4px;
  background: var(--bg);
  color: var(--text);
  outline: none;
}
.ctrl select:focus, .ctrl input:focus { border-color: var(--accent); }
.ctrl input[type="number"] { width: 68px; }
.ctrl input[type="text"] { width: 190px; }

.toggle-wrap {
  display: flex; align-items: center; gap: 6px; padding-bottom: 2px;
}
.toggle-wrap label.tl { font-size: 0.82rem; font-weight: 400; color: var(--text-mid); text-transform: none; letter-spacing: 0; cursor: pointer; }
.tsw { position: relative; width: 34px; height: 18px; cursor: pointer; }
.tsw input { opacity: 0; width: 0; height: 0; }
.tsw span { position: absolute; inset: 0; background: var(--border); border-radius: 9px; transition: 0.2s; }
.tsw span::before { content:''; position: absolute; height: 12px; width: 12px; left: 3px; top: 3px; background: #fff; border-radius: 50%; transition: 0.2s; }
.tsw input:checked + span { background: var(--accent); }
.tsw input:checked + span::before { transform: translateX(16px); }

/* Filter tags */
.filter-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; min-height: 24px; align-items: center; }
.filter-tags .ftl { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-faint); font-weight: 600; }
.ftag { display: inline-flex; align-items: center; gap: 5px; padding: 2px 10px; background: var(--surface-alt); border-radius: 3px; font-size: 0.76rem; color: var(--text-mid); }
.ftag .fx { cursor: pointer; color: var(--text-faint); line-height: 1; }
.ftag .fx:hover { color: var(--accent); }
.clear-btn { font-size: 0.76rem; color: var(--accent); cursor: pointer; text-decoration: underline; background: none; border: none; font-family: inherit; }

/* === MULTI-SELECT AUTOCOMPLETE === */
.ctrl.search-ctrl {
  flex: 1;
  min-width: 280px;
  max-width: 400px;
  position: relative;
}

.search-input {
  font-family: 'Source Sans 3', sans-serif;
  font-size: 0.84rem;
  padding: 5px 10px;
  width: 100%;
  border: 1.5px solid var(--border);
  border-radius: 4px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: border-color 0.15s;
}

.search-input:focus {
  border-color: var(--accent);
}

.search-input::placeholder {
  color: var(--text-faint);
  font-weight: 300;
}

/* Autocomplete Dropdown */
.autocomplete-dropdown {
  position: absolute;
  top: calc(100% + 2px);
  left: 0;
  right: 0;
  max-height: 320px;
  overflow-y: auto;
  background: var(--surface);
  border: 1.5px solid var(--accent);
  border-radius: 4px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  z-index: 1000;
  scrollbar-width: thin;
  scrollbar-color: var(--border) var(--surface);
}

.autocomplete-dropdown.hidden {
  display: none;
}

.autocomplete-dropdown::-webkit-scrollbar {
  width: 8px;
}

.autocomplete-dropdown::-webkit-scrollbar-track {
  background: var(--surface);
}

.autocomplete-dropdown::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}

.autocomplete-item {
  padding: 8px 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  border-bottom: 1px solid var(--border-light);
  transition: background 0.1s;
}

.autocomplete-item:last-child {
  border-bottom: none;
}

.autocomplete-item:hover {
  background: var(--surface-alt);
}

.autocomplete-item:active {
  background: var(--accent-light);
}

.autocomplete-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
  border: 1px solid rgba(0,0,0,0.1);
}

.autocomplete-name {
  flex: 1;
  font-size: 0.84rem;
  font-weight: 400;
  color: var(--text);
}

.autocomplete-c3 {
  font-size: 0.72rem;
  font-weight: 500;
  color: var(--text-light);
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.02em;
}

.autocomplete-region {
  font-size: 0.68rem;
  color: var(--text-faint);
  font-style: italic;
  margin-left: auto;
  padding-left: 8px;
}

.autocomplete-empty {
  padding: 16px 12px;
  text-align: center;
  font-size: 0.8rem;
  color: var(--text-light);
  font-style: italic;
}

.autocomplete-item.keyboard-focus {
  background: var(--accent-light);
  outline: 2px solid var(--accent);
  outline-offset: -2px;
}

/* Chip Container */
.chip-container {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
  min-height: 28px;
  align-items: center;
  max-height: 120px;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}

.chip-container::-webkit-scrollbar {
  height: 6px;
}

.chip-container::-webkit-scrollbar-track {
  background: transparent;
}

.chip-container::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

.chip-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-faint);
  font-weight: 600;
  margin-right: 4px;
}

.chip {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 8px 3px 6px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 3px;
  font-size: 0.76rem;
  color: var(--text);
  transition: all 0.15s;
  cursor: default;
  user-select: none;
  animation: chipEnter 0.15s ease-out;
}

.chip:hover {
  background: var(--surface-alt);
  border-color: var(--accent);
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.chip.removing {
  animation: chipExit 0.12s ease-in forwards;
}

.chip-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
  border: 1px solid rgba(0,0,0,0.15);
}

.chip-text {
  font-weight: 500;
  max-width: 180px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.chip-x {
  cursor: pointer;
  color: var(--text-faint);
  font-size: 1rem;
  line-height: 1;
  padding: 0 2px;
  margin-left: 2px;
  transition: color 0.15s;
  font-weight: 700;
}

.chip-x:hover {
  color: var(--accent);
  transform: scale(1.2);
}

.chip-x:active {
  transform: scale(0.95);
}

.chip-count {
  font-size: 0.76rem;
  color: var(--text-mid);
  font-weight: 600;
  margin-left: 4px;
}

.chip-count.max-warning {
  color: var(--accent);
}

.clear-chips-btn {
  font-size: 0.72rem;
  color: var(--accent);
  cursor: pointer;
  text-decoration: underline;
  background: none;
  border: none;
  font-family: inherit;
  padding: 0 4px;
  transition: opacity 0.15s;
}

.clear-chips-btn:hover {
  opacity: 0.7;
}

.clear-chips-btn:active {
  opacity: 0.5;
}

.chip-container.at-max {
  border: 1px dashed var(--accent);
  border-radius: 4px;
  padding: 4px;
}

.search-input:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

.chip-x:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 1px;
  border-radius: 2px;
}

/* Animations */
@keyframes chipEnter {
  from {
    opacity: 0;
    transform: scale(0.8) translateY(-4px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

@keyframes chipExit {
  from {
    opacity: 1;
    transform: scale(1);
  }
  to {
    opacity: 0;
    transform: scale(0.7);
  }
}

@keyframes dropdownSlide {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.autocomplete-dropdown:not(.hidden) {
  animation: dropdownSlide 0.15s ease-out;
}

/* Screen reader only */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  white-space: nowrap;
  border-width: 0;
}

/* Mobile responsive */
@media (max-width: 640px) {
  .search-ctrl {
    min-width: 100%;
    max-width: 100%;
  }

  .chip-container {
    max-height: 96px;
  }

  .chip-text {
    max-width: 140px;
  }

  .autocomplete-dropdown {
    max-height: 240px;
  }

  .chip-x {
    padding: 4px;
    font-size: 1.1rem;
  }

  .autocomplete-item {
    padding: 12px;
  }
}

@media (max-width: 480px) {
  .autocomplete-region {
    display: none;
  }
}

@media (prefers-reduced-motion: reduce) {
  .chip,
  .autocomplete-dropdown {
    animation: none !important;
  }

  * {
    transition-duration: 0.01ms !important;
  }
}

/* === CHART AREA === */
.chart-wrap {
  background: var(--surface);
  border: 1px solid var(--border-light);
  border-radius: 6px;
  padding: 20px 24px 16px;
  margin-bottom: 8px;
  position: relative;
}
.chart-wrap svg { cursor: grab; }
.chart-wrap svg:active { cursor: grabbing; }
.zoom-hint {
  position: absolute;
  bottom: 24px;
  right: 28px;
  font-size: 0.7rem;
  color: var(--text-faint);
  pointer-events: none;
  transition: opacity 0.4s;
}
.zoom-controls {
  position: absolute;
  top: 24px;
  right: 28px;
  display: flex;
  gap: 4px;
}
.zoom-btn {
  font-family: 'Source Sans 3', sans-serif;
  font-size: 0.72rem;
  padding: 3px 10px;
  background: var(--surface-alt);
  border: 1px solid var(--border);
  border-radius: 3px;
  cursor: pointer;
  color: var(--text-mid);
  transition: background 0.15s;
}
.zoom-btn:hover { background: var(--border-light); color: var(--text); }
.zoom-btn.hidden { display: none; }
.zoom-sep { width: 1px; height: 20px; background: var(--border-light); margin: 0 2px; }
.download-btn { background: var(--accent); color: #fff !important; border-color: var(--accent); font-weight: 600; letter-spacing: 0.01em; }
.download-btn:hover:not(:disabled) { background: #9A2F16 !important; color: #fff !important; }
.download-btn:disabled { background: #AAA !important; border-color: #AAA !important; cursor: wait; opacity: 0.8; }
.download-btn.done { background: #2D7A50 !important; border-color: #2D7A50 !important; }
.dl-wrap { position: relative; }
.dl-pop { position: absolute; top: calc(100% + 6px); right: 0; background: var(--bg); border: 1px solid var(--border-light); border-radius: 8px; padding: 10px 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.12); z-index: 50; min-width: 280px; }
.dl-pop.hidden { display: none; }
.dl-pop-label { font-size: 0.7rem; color: var(--text-mid); margin-bottom: 4px; display: block; }
.dl-pop-row { display: flex; align-items: center; gap: 2px; }
.dl-pop-input { flex: 1; font-size: 0.82rem; padding: 5px 8px; border: 1px solid var(--border-light); border-radius: 5px 0 0 5px; font-family: inherit; color: var(--text); background: var(--bg); outline: none; min-width: 0; }
.dl-pop-input:focus { border-color: var(--accent); }
.dl-pop-ext { font-size: 0.78rem; color: var(--text-faint); padding: 5px 4px 5px 0; background: var(--bg); border: 1px solid var(--border-light); border-left: none; border-radius: 0; }
.dl-pop-go { padding: 5px 14px; font-size: 0.82rem; font-weight: 600; background: var(--accent); color: #fff; border: none; border-radius: 0 5px 5px 0; cursor: pointer; white-space: nowrap; }
.dl-pop-go:hover { background: #9A2F16; }

/* Fullscreen mode */
.chart-wrap.fullscreen {
  position: fixed;
  inset: 0;
  z-index: 9999;
  border-radius: 0;
  border: none;
  margin: 0;
  padding: 16px 20px;
  overflow: auto;
  background: var(--surface);
}
.chart-wrap.fullscreen .zoom-controls { top: 16px; right: 20px; }
.chart-wrap.fullscreen .zoom-hint { bottom: 16px; right: 20px; }
.fs-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 9998;
}
.fs-overlay.active { display: block; }
.count-bar {
  font-size: 0.78rem;
  color: var(--text-light);
  margin-bottom: 8px;
}
.count-bar strong { color: var(--text); font-weight: 600; }

/* Gini explainer */
.gini-explainer {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.74rem;
  color: var(--text-light);
  margin-bottom: 14px;
  padding: 6px 10px;
  background: var(--surface-alt);
  border-radius: 4px;
  line-height: 1.4;
}
.gini-explainer .info-icon {
  flex-shrink: 0;
  width: 16px; height: 16px;
  border-radius: 50%;
  background: var(--text-faint);
  color: #fff;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.65rem; font-weight: 700;
}

/* === LEGEND (horizontal, below controls) === */
.legend-row {
  display: flex;
  flex-wrap: wrap;
  gap: 4px 16px;
  margin-bottom: 16px;
  align-items: center;
}
.legend-row .lr-label {
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-faint);
  margin-right: 4px;
}
.lr-item {
  display: flex; align-items: center; gap: 5px;
  font-size: 0.78rem; color: var(--text-mid);
  cursor: pointer; user-select: none; transition: opacity 0.15s;
  padding: 2px 0;
}
.lr-item:hover { color: var(--text); }
.lr-item.dimmed { opacity: 0.25; }
.lr-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

/* Tooltip */
.tip {
  position: fixed; pointer-events: none;
  background: rgba(30,30,28,0.94); color: #fff;
  padding: 12px 16px; border-radius: 6px;
  font-size: 0.8rem; line-height: 1.55; max-width: 300px;
  z-index: 1000; opacity: 0; transition: opacity 0.12s;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}
.tip .tip-name { font-weight: 700; font-size: 0.95rem; margin-bottom: 5px; font-family: 'Playfair Display', serif; }
.tip .tip-r { display: flex; justify-content: space-between; gap: 14px; }
.tip .tip-l { color: #AAA; }
.tip .tip-v { font-family: 'JetBrains Mono', monospace; font-size: 0.76rem; }
.tip .tip-badge { display: inline-block; padding: 1px 7px; border-radius: 2px; font-size: 0.66rem; font-weight: 500; margin-top: 5px; }
.tip .tip-badge.obs { background: rgba(58,134,96,0.25); color: #7AD4A8; }
.tip .tip-badge.ext { background: rgba(186,58,30,0.2); color: #F2A899; }

/* Axis labels */
.ax-label { font-family: 'Source Sans 3', sans-serif; font-size: 12.5px; font-weight: 500; fill: var(--text-mid); }
/* Axis tick styling via CSS instead of per-render JS */
.gx text, .gy text { font-family: 'Source Sans 3', sans-serif; font-size: 11px; fill: var(--text-light); }
.gx line, .gy line { stroke: #E8E6DF; stroke-dasharray: 2,3; }
.gx .domain, .gy .domain { stroke: #C8C5BA; }
/* Quadrant labels */
.q-label { font-family: 'Source Sans 3', sans-serif; font-size: 11.5px; font-weight: 600; pointer-events: none; }
/* Country labels on chart */
.c-label { font-family: 'Source Sans 3', sans-serif; font-size: 10px; font-weight: 500; pointer-events: none; }
/* === BELOW-CHART ANALYSIS === */
.analysis-section {
  margin-top: 40px;
}
.analysis-section h2 {
  font-family: 'Playfair Display', serif;
  font-size: 1.35rem;
  font-weight: 700;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--text);
}

/* Quadrant cards */
.quad-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 14px;
  margin-bottom: 36px;
}
.q-card {
  border-radius: 6px;
  padding: 18px 20px;
  border-left: 4px solid;
}
.q-card h3 {
  font-size: 0.9rem;
  font-weight: 700;
  margin-bottom: 2px;
}
.q-card .q-sub {
  font-size: 0.78rem;
  color: var(--text-mid);
  margin-bottom: 10px;
  font-style: italic;
}
.q-card .q-stat-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  padding: 3px 0;
}
.q-card .q-big {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.3rem;
  font-weight: 700;
}
.q-card .q-stat-label {
  font-size: 0.76rem;
  color: var(--text-mid);
}
.q-card .q-regions {
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px solid rgba(0,0,0,0.08);
}
.q-card .q-reg-row {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.74rem;
  color: var(--text-mid);
  line-height: 1.8;
}
.q-reg-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.q-reg-n { margin-left: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; font-weight: 500; color: var(--text); }

/* Key takeaways */
.takeaways {
  margin-bottom: 36px;
}
.takeaways h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem;
  font-weight: 700;
  margin-bottom: 12px;
}
.tk-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.tk-item {
  display: flex;
  gap: 12px;
  align-items: flex-start;
  padding: 12px 16px;
  background: var(--surface);
  border: 1px solid var(--border-light);
  border-radius: 6px;
}
.tk-num {
  flex-shrink: 0;
  width: 28px; height: 28px;
  background: var(--accent);
  color: #fff;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.78rem; font-weight: 700;
}
.tk-text {
  font-size: 0.88rem;
  color: var(--text-mid);
  line-height: 1.55;
}
.tk-text strong { color: var(--text); font-weight: 600; }

/* Biggest movers table */
.movers-section {
  margin-bottom: 36px;
}
.movers-section h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem;
  font-weight: 700;
  margin-bottom: 12px;
}
.movers-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.mover-block h4 {
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text-mid);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}
.mover-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.82rem;
}
.mover-table th {
  text-align: left;
  font-weight: 600;
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-faint);
  padding: 6px 8px;
  border-bottom: 2px solid var(--border);
}
.mover-table td {
  padding: 7px 8px;
  border-bottom: 1px solid var(--border-light);
  color: var(--text-mid);
}
.mover-table td:first-child { font-weight: 500; color: var(--text); }
.mover-table .chg-down { color: #2D7A50; font-family: 'JetBrains Mono', monospace; font-weight: 500; }
.mover-table .chg-up { color: #C44536; font-family: 'JetBrains Mono', monospace; font-weight: 500; }

/* Regional summary */
.regional-section { margin-bottom: 36px; }
.regional-section h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem;
  font-weight: 700;
  margin-bottom: 12px;
}
.reg-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 12px;
}
.reg-card {
  padding: 14px 16px;
  background: var(--surface);
  border: 1px solid var(--border-light);
  border-radius: 6px;
  border-top: 3px solid var(--border);
}
.reg-card .rc-name { font-size: 0.82rem; font-weight: 600; margin-bottom: 6px; }
.reg-card .rc-stat { font-size: 0.76rem; color: var(--text-mid); line-height: 1.65; }
.reg-card .rc-stat span { font-family: 'JetBrains Mono', monospace; font-weight: 500; color: var(--text); }

/* Source / methodology */
.source-block {
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}
.source-block p {
  font-size: 0.74rem;
  color: var(--text-light);
  line-height: 1.6;
  margin-bottom: 4px;
}
.source-block strong { color: var(--text-mid); }

/* Hero stats */
.hero-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}
.hero-card {
  padding: 20px 22px;
  background: var(--surface);
  border: 1px solid var(--border-light);
  border-radius: 8px;
  text-align: center;
}
.hero-card.accent {
  background: #C44536;
  border-color: #C44536;
  color: #fff;
}
.hero-card.accent .hero-label,
.hero-card.accent .hero-sub { color: rgba(255,255,255,0.85); }
.hero-card .hero-num {
  font-family: 'Playfair Display', serif;
  font-size: 2.2rem;
  font-weight: 800;
  line-height: 1.1;
  margin-bottom: 4px;
}
.hero-card .hero-label {
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text-mid);
  margin-bottom: 2px;
}
.hero-card .hero-sub {
  font-size: 0.72rem;
  color: var(--text-light);
  line-height: 1.3;
}

/* Spotlight section */
.spotlight-section { margin-bottom: 36px; }
.spotlight-section h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem;
  font-weight: 700;
  margin-bottom: 4px;
}
.section-sub {
  font-size: 0.78rem;
  color: var(--text-light);
  margin-bottom: 14px;
}
.spotlight-grid {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.spot-row {
  display: grid;
  grid-template-columns: 140px 1fr 60px;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: var(--surface);
  border: 1px solid var(--border-light);
  border-radius: 4px;
  font-size: 0.82rem;
}
.spot-row .spot-name { font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.spot-row .spot-pop { font-size: 0.7rem; color: var(--text-faint); }
.spot-bar-wrap {
  position: relative;
  height: 22px;
  background: var(--surface-alt);
  border-radius: 3px;
  overflow: hidden;
}
.spot-bar-1990 {
  position: absolute;
  top: 0; left: 0;
  height: 100%;
  background: rgba(0,0,0,0.08);
  border-right: 2px dashed var(--text-faint);
}
.spot-bar-2022 {
  position: absolute;
  top: 0; left: 0;
  height: 100%;
  border-radius: 3px;
}
.spot-bar-label {
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem;
  font-weight: 600;
  color: var(--text);
}
.spot-change {
  text-align: right;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.82rem;
  font-weight: 600;
}
.spot-change.down { color: #2D7A50; }
.spot-change.up { color: #C44536; }

/* Movers filters */
.movers-filters {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}
.movers-filters .ctrl { flex: 0 0 auto; }
.movers-filters select {
  font-size: 0.78rem;
  padding: 4px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--surface);
  font-family: inherit;
}

/* Counterfactual */
.counterfactual {
  margin-top: 24px;
  padding: 20px 24px;
  background: linear-gradient(135deg, #E8F0F8, #E6F2EC);
  border-radius: 8px;
  border-left: 4px solid #336B99;
  margin-bottom: 36px;
}
.counterfactual h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem;
  font-weight: 700;
  margin-bottom: 6px;
  color: #336B99;
}
.counterfactual p {
  font-size: 0.88rem;
  color: var(--text-mid);
  line-height: 1.55;
}
.counterfactual .cf-big {
  font-family: 'Playfair Display', serif;
  font-size: 1.8rem;
  font-weight: 800;
  color: #336B99;
  display: block;
  margin: 8px 0;
}

/* Responsive */
@media (max-width: 768px) {
  .page { padding: 20px 16px 60px; }
  .header h1 { font-size: 1.45rem; }
  .movers-grid { grid-template-columns: 1fr; }
  .controls { gap: 10px; padding: 12px 14px; }
  .hero-stats { grid-template-columns: 1fr; }
  .hero-card .hero-num { font-size: 1.7rem; }
  .spot-row { grid-template-columns: 100px 1fr 50px; }
  .movers-filters { flex-wrap: wrap; }
}
</style>
</head>
<body>

<div class="page">
  <!-- HEADER -->
  <div class="header">
    <h1 id="mainHeadline">Most countries reduced inequality since 1990 — but hundreds of millions are still being left&nbsp;behind</h1>
    <p class="dek" id="mainDek">Since 1990, most countries have reduced income inequality. But the gains are unevenly distributed — in South Asia and Sub-Saharan Africa, home to nearly half the world's population, many countries remain deeply unequal, and some are moving in the wrong direction.</p>
    <div class="divider"></div>
  </div>

  <!-- HERO STAT -->
  <div class="hero-stats" id="heroStats"></div>

  <!-- CONTROLS -->
  <div class="controls" id="controls">
    <div class="ctrl">
      <label>Region</label>
      <select id="regionFilter"><option value="all">All Regions</option></select>
    </div>
    <div class="ctrl">
      <label>Income Group</label>
      <select id="incomeFilter"><option value="all">All Income Groups</option></select>
    </div>
    <div class="ctrl">
      <label>Base Year</label>
      <select id="baseYearSelect">
        <option value="1990">1990</option>
        <option value="2000">2000</option>
        <option value="2010">2010</option>
        <option value="2019">2019</option>
      </select>
    </div>
    <div class="ctrl">
      <label>Final Year</label>
      <select id="finalYearSelect">
        <option value="2000">2000</option>
        <option value="2010">2010</option>
        <option value="2019">2019</option>
        <option value="2022" selected>2022</option>
      </select>
    </div>
    <div class="ctrl">
      <label>X-Axis</label>
      <select id="xAxisSelect">
        <option value="base">Base Year</option>
        <option value="final">Final Year</option>
      </select>
    </div>
    <div class="ctrl">
      <label>Threshold</label>
      <input type="number" id="thresholdInput" value="40" min="20" max="80" step="1">
    </div>
    <div class="ctrl">
      <label>Bubble Size</label>
      <select id="sizeBySelect">
        <option value="none">Uniform</option>
        <option value="population" selected>Population</option>
        <option value="gdp">GDP per capita</option>
      </select>
    </div>
    <div class="ctrl search-ctrl">
      <label>Select Countries</label>
      <input
        type="text"
        id="countrySearch"
        class="search-input"
        placeholder="Type to search (e.g., Brazil, IND, South Asia)…"
        autocomplete="off"
        aria-label="Search countries to select"
        aria-autocomplete="list"
        aria-controls="autocomplete-list"
        aria-expanded="false"
        role="combobox"
      />
      <div id="autocomplete-list" class="autocomplete-dropdown hidden" role="listbox" aria-label="Country search results"></div>
    </div>
    <div class="ctrl">
      <div class="toggle-wrap">
        <label class="tsw"><input type="checkbox" id="labelToggle" checked><span></span></label>
        <label class="tl" for="labelToggle">Labels</label>
      </div>
    </div>
  </div>

  <!-- SELECTED COUNTRIES CHIPS -->
  <div class="chip-container" id="chipContainer" role="list" aria-label="Selected countries" aria-live="polite" aria-atomic="false">
    <span class="chip-label">Selected:</span>
    <span class="chip-count" id="chipCount" aria-live="polite" aria-atomic="true">0 / 20</span>
  </div>

  <!-- FILTER TAGS -->
  <div class="filter-tags" id="filterTags"></div>

  <!-- Screen reader announcer -->
  <div id="sr-announcer" class="sr-only" role="status" aria-live="polite" aria-atomic="true"></div>

  <!-- LEGEND (horizontal) -->
  <div class="legend-row" id="legendRow">
    <span class="lr-label">Regions</span>
  </div>

  <!-- GINI EXPLAINER -->
  <div class="gini-explainer">
    <span class="info-icon">i</span>
    <span>The <strong>Gini index</strong> measures income inequality from 0 (everyone earns the same) to 100 (one person earns everything). A value above 50 indicates high inequality. The vertical axis shows how much each country's Gini changed between the selected base and final years — negative means inequality fell.</span>
  </div>

  <!-- COUNT -->
  <div class="count-bar" id="countBar"></div>

  <div class="fs-overlay" id="fsOverlay"></div>

  <!-- CHART -->
  <div class="chart-wrap" id="chartWrap">
    <div class="zoom-controls">
      <button class="zoom-btn" id="zoomInBtn" title="Zoom in">+</button>
      <button class="zoom-btn" id="zoomOutBtn" title="Zoom out">−</button>
      <button class="zoom-btn hidden" id="resetZoomBtn">Reset zoom</button>
      <button class="zoom-btn" id="expandBtn" title="Expand chart">⛶ Expand</button>
      <span class="zoom-sep"></span>
      <div class="dl-wrap">
        <button class="zoom-btn download-btn" id="downloadBtn" title="Download chart as image">⬇ Download</button>
        <div class="dl-pop hidden" id="dlPop">
          <label class="dl-pop-label">Filename</label>
          <div class="dl-pop-row">
            <input type="text" id="dlFilename" class="dl-pop-input" spellcheck="false">
            <span class="dl-pop-ext">.png</span>
            <button class="dl-pop-go" id="dlConfirm">Save</button>
          </div>
        </div>
      </div>
    </div>
    <div class="zoom-hint" id="zoomHint">Scroll to zoom · Drag to pan</div>
  </div>

  <!-- BELOW-CHART ANALYSIS -->
  <div class="analysis-section" id="analysisSection">
    <h2>What the data tells us</h2>

    <!-- Quadrant cards -->
    <div class="quad-cards" id="quadCards"></div>

    <!-- Key takeaways (hierarchical: shock stat + supporting) -->
    <div class="takeaways" id="takeaways">
      <h3>Key findings</h3>
      <div class="tk-list" id="tkList"></div>
    </div>

    <!-- Country spotlight: large population countries -->
    <div class="spotlight-section">
      <h3>Country spotlight — largest populations</h3>
      <p class="section-sub" id="spotlightSub">How the world's most populous countries changed. Bars show Gini level; arrow shows direction of change.</p>
      <div class="spotlight-grid" id="spotlightGrid"></div>
    </div>

    <!-- Biggest movers with filters -->
    <div class="movers-section">
      <h3 id="moversTitle">Biggest movers</h3>
      <div class="movers-filters">
        <div class="ctrl">
          <label>Region</label>
          <select id="moverRegionFilter"><option value="all">All Regions</option></select>
        </div>
        <div class="ctrl">
          <label>Income Group</label>
          <select id="moverIncomeFilter"><option value="all">All Income Groups</option></select>
        </div>
      </div>
      <div class="movers-grid" id="moversGrid"></div>
    </div>

    <!-- Regional summary (sorted by severity) -->
    <div class="regional-section">
      <h3>Regional snapshot — ranked by average inequality</h3>
      <div class="reg-cards" id="regCards"></div>
    </div>

    <!-- Counterfactual -->
    <div class="counterfactual" id="counterfactual"></div>
  </div>

  <!-- SOURCE -->
  <div class="source-block">
    <p><strong>Source:</strong> UNU-WIDER, World Income Inequality Database (WIID) Companion dataset (wiidcountry and/or wiidglobal). Version 28 April 2025. <a href="https://doi.org/10.35188/UNU-WIDER/WIIDcomp-280425" style="color:var(--text-mid)">https://doi.org/10.35188/UNU-WIDER/WIIDcomp-280425</a></p>
    <p><strong>Methodology:</strong> Change is calculated as Gini(2022) − Gini(1990). The quadrant threshold is set at 40 by default but is configurable above. Gini values range from 0 (perfect equality) to 100 (maximum inequality).</p>
  </div>
</div>

<div class="tip" id="tip"></div>

<script>
// ===== DATA =====
const RAW_DATA = [{"country": "Afghanistan", "c3": "AFG", "region_wb": "South Asia", "region_un": "Asia", "incomegroup": "Low income", "population": 40578844.0, "gdp": 1981.71, "gini_1990": 44.353001, "gini_2000": 44.353001, "gini_2010": 43.615002, "gini_2019": 44.967999, "gini_2022": 44.967999, "interpolated": "Extrapolated"}, {"country": "Albania", "c3": "ALB", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "Upper middle income", "population": 2827608.0, "gdp": 17352.85, "gini_1990": 32.310001, "gini_2000": 34.882999, "gini_2010": 34.389999, "gini_2019": 35.433998, "gini_2022": 34.5, "interpolated": "Extrapolated"}, {"country": "Algeria", "c3": "DZA", "region_wb": "Middle East and North Africa", "region_un": "Africa", "incomegroup": "Upper middle income", "population": 45477392.0, "gdp": 14782.2, "gini_1990": 36.174, "gini_2000": 33.286999, "gini_2010": 29.655001, "gini_2019": 28.929001, "gini_2022": 28.929001, "interpolated": "Extrapolated"}, {"country": "Andorra", "c3": "AND", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 79705.0, "gdp": 63913.379, "gini_1990": 29.877001, "gini_2000": 29.877001, "gini_2010": 30.193001, "gini_2019": 30.464001, "gini_2022": 30.464001, "interpolated": "Extrapolated"}, {"country": "Angola", "c3": "AGO", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 35635028.0, "gdp": 7397.4902, "gini_1990": 63.145, "gini_2000": 63.145, "gini_2010": 57.068001, "gini_2019": 62.707001, "gini_2022": 62.707001, "interpolated": "Extrapolated"}, {"country": "Argentina", "c3": "ARG", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 45407904.0, "gdp": 27627.961, "gini_1990": 44.242001, "gini_2000": 48.601002, "gini_2010": 41.014999, "gini_2019": 40.353001, "gini_2022": 37.715, "interpolated": "No"}, {"country": "Armenia", "c3": "ARM", "region_wb": "Europe and Central Asia", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 2880874.0, "gdp": 17886.18, "gini_1990": 44.143002, "gini_2000": 42.062, "gini_2010": 37.424, "gini_2019": 37.525002, "gini_2022": 35.951, "interpolated": "No"}, {"country": "Australia", "c3": "AUS", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "High income", "population": 26200984.0, "gdp": 58997.699, "gini_1990": 33.113998, "gini_2000": 33.605, "gini_2010": 34.818001, "gini_2019": 34.34, "gini_2022": 34.34, "interpolated": "Extrapolated"}, {"country": "Austria", "c3": "AUT", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 9064677.0, "gdp": 66294.719, "gini_1990": 25.955999, "gini_2000": 29.031, "gini_2010": 31.42, "gini_2019": 30.981001, "gini_2022": 30.882999, "interpolated": "No"}, {"country": "Azerbaijan", "c3": "AZE", "region_wb": "Europe and Central Asia", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 10295304.0, "gdp": 21051.27, "gini_1990": 41.27, "gini_2000": 42.404999, "gini_2010": 24.954, "gini_2019": 19.211, "gini_2022": 19.211, "interpolated": "Extrapolated"}, {"country": "Bahamas, The", "c3": "BHS", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "High income", "population": 397538.0, "gdp": 32408.711, "gini_1990": 50.388, "gini_2000": 51.543999, "gini_2010": 50.443001, "gini_2019": 50.037998, "gini_2022": 50.037998, "interpolated": "Extrapolated"}, {"country": "Bahrain", "c3": "BHR", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "High income", "population": 1533459.0, "gdp": 57465.172, "gini_1990": 36.994999, "gini_2000": 38.004002, "gini_2010": 38.280998, "gini_2019": 34.674999, "gini_2022": 34.509998, "interpolated": "Extrapolated"}, {"country": "Bangladesh", "c3": "BGD", "region_wb": "South Asia", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 169384896.0, "gdp": 7888.1602, "gini_1990": 41.726002, "gini_2000": 45.159, "gini_2010": 46.157001, "gini_2019": 49.094002, "gini_2022": 49.775002, "interpolated": "No"}, {"country": "Barbados", "c3": "BRB", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "High income", "population": 282318.0, "gdp": 18469.58, "gini_1990": 50.882, "gini_2000": 53.682999, "gini_2010": 56.485001, "gini_2019": 56.485001, "gini_2022": 56.485001, "interpolated": "Extrapolated"}, {"country": "Belarus", "c3": "BLR", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "Upper middle income", "population": 9173237.0, "gdp": 26537.51, "gini_1990": 24.344, "gini_2000": 38.494999, "gini_2010": 36.471001, "gini_2019": 33.862999, "gini_2022": 33.119999, "interpolated": "Extrapolated"}, {"country": "Belgium", "c3": "BEL", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 11641820.0, "gdp": 63974.25, "gini_1990": 25.315001, "gini_2000": 31.393, "gini_2010": 28.424, "gini_2019": 27.487, "gini_2022": 26.788, "interpolated": "No"}, {"country": "Belize", "c3": "BLZ", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 402733.0, "gdp": 12569.82, "gini_1990": 59.182999, "gini_2000": 53.048, "gini_2010": 53.048, "gini_2019": 53.048, "gini_2022": 53.048, "interpolated": "Extrapolated"}, {"country": "Benin", "c3": "BEN", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 13759501.0, "gdp": 3588.3401, "gini_1990": 50.756001, "gini_2000": 52.557999, "gini_2010": 52.886002, "gini_2019": 52.612999, "gini_2022": 49.862, "interpolated": "No"}, {"country": "Bhutan", "c3": "BTN", "region_wb": "South Asia", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 780914.0, "gdp": 14061.31, "gini_1990": 52.998001, "gini_2000": 52.998001, "gini_2010": 51.203999, "gini_2019": 47.553001, "gini_2022": 43.310001, "interpolated": "No"}, {"country": "Bolivia", "c3": "BOL", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Lower middle income", "population": 12077154.0, "gdp": 9681.71, "gini_1990": 51.796001, "gini_2000": 62.807999, "gini_2010": 48.742001, "gini_2019": 42.799999, "gini_2022": 41.692001, "interpolated": "Extrapolated"}, {"country": "Bosnia and Herzegovina", "c3": "BIH", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "Upper middle income", "population": 3204802.0, "gdp": 19569.77, "gini_1990": 28.179001, "gini_2000": 32.087002, "gini_2010": 36.460999, "gini_2019": 36.450001, "gini_2022": 36.450001, "interpolated": "Extrapolated"}, {"country": "Botswana", "c3": "BWA", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Upper middle income", "population": 2439892.0, "gdp": 18648.131, "gini_1990": 59.887001, "gini_2000": 64.749001, "gini_2010": 62.584999, "gini_2019": 56.993, "gini_2022": 56.993, "interpolated": "Extrapolated"}, {"country": "Brazil", "c3": "BRA", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 210306416.0, "gdp": 18554.051, "gini_1990": 55.169998, "gini_2000": 53.424999, "gini_2010": 49.73, "gini_2019": 50.384998, "gini_2022": 47.999001, "interpolated": "No"}, {"country": "Brunei", "c3": "BRN", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "High income", "population": 455370.0, "gdp": 76357.828, "gini_1990": 31.497999, "gini_2000": 31.497999, "gini_2010": 28.111, "gini_2019": 28.673, "gini_2022": 28.673, "interpolated": "Extrapolated"}, {"country": "Bulgaria", "c3": "BGR", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 6825864.0, "gdp": 31813.939, "gini_1990": 24.534, "gini_2000": 30.777, "gini_2010": 33.825001, "gini_2019": 41.161999, "gini_2022": 39.014, "interpolated": "No"}, {"country": "Burkina Faso", "c3": "BFA", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 22509038.0, "gdp": 2466.05, "gini_1990": 60.425999, "gini_2000": 59.804001, "gini_2010": 53.349998, "gini_2019": 56.688999, "gini_2022": 52.261002, "interpolated": "No"}, {"country": "Burundi", "c3": "BDI", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 13321097.0, "gdp": 829.39001, "gini_1990": 49.157001, "gini_2000": 54.917999, "gini_2010": 51.116001, "gini_2019": 52.583, "gini_2022": 52.325001, "interpolated": "Extrapolated"}, {"country": "Cambodia", "c3": "KHM", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 17201724.0, "gdp": 6456.7402, "gini_1990": 46.175999, "gini_2000": 45.945, "gini_2010": 47.588001, "gini_2019": 46.548, "gini_2022": 46.548, "interpolated": "Extrapolated"}, {"country": "Cameroon", "c3": "CMR", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 27632772.0, "gdp": 4843.6499, "gini_1990": 57.591, "gini_2000": 56.158001, "gini_2010": 57.775002, "gini_2019": 57.292999, "gini_2022": 55.973, "interpolated": "No"}, {"country": "Canada", "c3": "CAN", "region_wb": "North America", "region_un": "Americas", "incomegroup": "High income", "population": 38821256.0, "gdp": 56872.609, "gini_1990": 31.834999, "gini_2000": 33.483002, "gini_2010": 33.616001, "gini_2019": 31.76, "gini_2022": 29.865, "interpolated": "Extrapolated"}, {"country": "Cape Verde", "c3": "CPV", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 519741.03125, "gdp": 8850.1104, "gini_1990": 63.903, "gini_2000": 63.903, "gini_2010": 58.768002, "gini_2019": 56.212002, "gini_2022": 56.212002, "interpolated": "Extrapolated"}, {"country": "Central African Republic", "c3": "CAF", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 5098039.0, "gdp": 1137.35, "gini_1990": 69.191002, "gini_2000": 60.841, "gini_2010": 65.050003, "gini_2019": 58.257, "gini_2022": 56.747002, "interpolated": "Extrapolated"}, {"country": "Chad", "c3": "TCD", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 18455316.0, "gdp": 1688.46, "gini_1990": 49.442001, "gini_2000": 53.098999, "gini_2010": 56.686001, "gini_2019": 52.374001, "gini_2022": 52.278, "interpolated": "No"}, {"country": "Chile", "c3": "CHL", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "High income", "population": 19553036.0, "gdp": 29557.391, "gini_1990": 52.734001, "gini_2000": 54.875, "gini_2010": 49.400002, "gini_2019": 50.011002, "gini_2022": 46.598, "interpolated": "No"}, {"country": "China", "c3": "CHN", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 1425179648.0, "gdp": 21011.619, "gini_1990": 35.905998, "gini_2000": 42.042, "gini_2010": 44.459999, "gini_2019": 44.073002, "gini_2022": 43.563999, "interpolated": "No"}, {"country": "Colombia", "c3": "COL", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 51737944.0, "gdp": 18788.41, "gini_1990": 52.532001, "gini_2000": 55.380001, "gini_2010": 54.533001, "gini_2019": 51.672001, "gini_2022": 55.073002, "interpolated": "No"}, {"country": "Comoros", "c3": "COM", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 834188.0, "gdp": 3463.01, "gini_1990": 66.308998, "gini_2000": 66.308998, "gini_2010": 61.646999, "gini_2019": 58.539001, "gini_2022": 58.539001, "interpolated": "Extrapolated"}, {"country": "Congo, Democratic Republic of the", "c3": "COD", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 102396968.0, "gdp": 1385.46, "gini_1990": 55.626999, "gini_2000": 55.626999, "gini_2010": 55.915001, "gini_2019": 57.653999, "gini_2022": 57.916, "interpolated": "Extrapolated"}, {"country": "Congo, Republic of the", "c3": "COG", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 6035104.0, "gdp": 6205.1001, "gini_1990": 59.979, "gini_2000": 59.979, "gini_2010": 60.826, "gini_2019": 61.165001, "gini_2022": 61.165001, "interpolated": "Extrapolated"}, {"country": "Costa Rica", "c3": "CRI", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 5081765.0, "gdp": 25131.029, "gini_1990": 44.971001, "gini_2000": 47.737, "gini_2010": 48.970001, "gini_2019": 49.348999, "gini_2022": 48.328999, "interpolated": "No"}, {"country": "Cote d'Ivoire", "c3": "CIV", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 30395002.0, "gdp": 6261.5298, "gini_1990": 55.393002, "gini_2000": 57.828999, "gini_2010": 57.491001, "gini_2019": 56.313999, "gini_2022": 54.414001, "interpolated": "No"}, {"country": "Croatia", "c3": "HRV", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 3907027.0, "gdp": 39844.141, "gini_1990": 28.179001, "gini_2000": 31.295, "gini_2010": 32.618999, "gini_2019": 29.74, "gini_2022": 28.931, "interpolated": "No"}, {"country": "Cuba", "c3": "CUB", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 11059820.0, "gdp": 9178.4697, "gini_1990": 48.265999, "gini_2000": 48.265999, "gini_2010": 48.265999, "gini_2019": 48.265999, "gini_2022": 48.265999, "interpolated": "Extrapolated"}, {"country": "Cyprus", "c3": "CYP", "region_wb": "Europe and Central Asia", "region_un": "Asia", "incomegroup": "High income", "population": 1331370.0, "gdp": 52882.289, "gini_1990": 30.045, "gini_2000": 30.045, "gini_2010": 32.076, "gini_2019": 32.695999, "gini_2022": 31.202999, "interpolated": "No"}, {"country": "Czechia", "c3": "CZE", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 10673213.0, "gdp": 50617.699, "gini_1990": 21.142, "gini_2000": 26.149, "gini_2010": 26.216999, "gini_2019": 25.219, "gini_2022": 26.445999, "interpolated": "No"}, {"country": "Denmark", "c3": "DNK", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 5902904.0, "gdp": 70865.438, "gini_1990": 25.466, "gini_2000": 23.813, "gini_2010": 26.158001, "gini_2019": 28.669001, "gini_2022": 29.594999, "interpolated": "No"}, {"country": "Djibouti", "c3": "DJI", "region_wb": "Middle East and North Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 1137096.0, "gdp": 6083.6401, "gini_1990": 50.266998, "gini_2000": 45.734001, "gini_2010": 46.750999, "gini_2019": 44.830002, "gini_2022": 44.830002, "interpolated": "Extrapolated"}, {"country": "Dominica", "c3": "DMA", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 66826.0, "gdp": 16557.641, "gini_1990": 56.174999, "gini_2000": 56.174999, "gini_2010": 56.174999, "gini_2019": 56.174999, "gini_2022": 56.174999, "interpolated": "Extrapolated"}, {"country": "Dominican Republic", "c3": "DOM", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 11230734.0, "gdp": 22757.391, "gini_1990": 50.249001, "gini_2000": 50.846001, "gini_2010": 47.973999, "gini_2019": 42.995998, "gini_2022": 38.006001, "interpolated": "No"}, {"country": "Ecuador", "c3": "ECU", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 17823896.0, "gdp": 14263.2, "gini_1990": 45.679001, "gini_2000": 55.313999, "gini_2010": 48.765999, "gini_2019": 45.424, "gini_2022": 44.518002, "interpolated": "No"}, {"country": "Egypt", "c3": "EGY", "region_wb": "Middle East and North Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 112618248.0, "gdp": 16360.39, "gini_1990": 37.806999, "gini_2000": 36.27, "gini_2010": 33.491001, "gini_2019": 35.419998, "gini_2022": 35.419998, "interpolated": "Extrapolated"}, {"country": "El Salvador", "c3": "SLV", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 6280319.0, "gdp": 11068.92, "gini_1990": 48.0, "gini_2000": 50.578999, "gini_2010": 45.230999, "gini_2019": 40.481998, "gini_2022": 38.676998, "interpolated": "No"}, {"country": "Equatorial Guinea", "c3": "GNQ", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Upper middle income", "population": 1803545.0, "gdp": 16932.77, "gini_1990": 54.883999, "gini_2000": 54.883999, "gini_2010": 54.883999, "gini_2019": 54.883999, "gini_2022": 54.883999, "interpolated": "Extrapolated"}, {"country": "Eritrea", "c3": "ERI", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 3409447.0, "gdp": 2655.5801, "gini_1990": 54.534, "gini_2000": 54.534, "gini_2010": 54.534, "gini_2019": 54.534, "gini_2022": 54.534, "interpolated": "Extrapolated"}, {"country": "Estonia", "c3": "EST", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 1350091.0, "gdp": 44492.121, "gini_1990": 31.622999, "gini_2000": 36.595001, "gini_2010": 31.841, "gini_2019": 30.457001, "gini_2022": 31.912001, "interpolated": "No"}, {"country": "Eswatini", "c3": "SWZ", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 1218917.0, "gdp": 9740.0703, "gini_1990": 68.303001, "gini_2000": 65.049004, "gini_2010": 63.152, "gini_2019": 65.574997, "gini_2022": 65.574997, "interpolated": "Extrapolated"}, {"country": "Ethiopia", "c3": "ETH", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 125384288.0, "gdp": 2655.5801, "gini_1990": 57.483002, "gini_2000": 46.361, "gini_2010": 48.493, "gini_2019": 50.469002, "gini_2022": 50.469002, "interpolated": "Extrapolated"}, {"country": "Fiji", "c3": "FJI", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "Upper middle income", "population": 919422.0, "gdp": 12762.35, "gini_1990": 46.584999, "gini_2000": 43.339001, "gini_2010": 42.973, "gini_2019": 34.841999, "gini_2022": 34.075001, "interpolated": "Extrapolated"}, {"country": "Finland", "c3": "FIN", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 5569299.0, "gdp": 58024.48, "gini_1990": 22.716, "gini_2000": 27.118, "gini_2010": 27.882999, "gini_2019": 27.368999, "gini_2022": 28.691999, "interpolated": "No"}, {"country": "France", "c3": "FRA", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 66277408.0, "gdp": 55106.328, "gini_1990": 32.229, "gini_2000": 32.605, "gini_2010": 33.395, "gini_2019": 32.528, "gini_2022": 31.555, "interpolated": "No"}, {"country": "Gabon", "c3": "GAB", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Upper middle income", "population": 2430747.0, "gdp": 18662.051, "gini_1990": 57.898998, "gini_2000": 51.456001, "gini_2010": 46.888, "gini_2019": 45.004002, "gini_2022": 45.004002, "interpolated": "Extrapolated"}, {"country": "Gambia, The", "c3": "GMB", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 2636470.0, "gdp": 2863.1799, "gini_1990": 69.948997, "gini_2000": 60.5, "gini_2010": 57.407001, "gini_2019": 52.470001, "gini_2022": 53.369999, "interpolated": "Extrapolated"}, {"country": "Georgia", "c3": "GEO", "region_wb": "Europe and Central Asia", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 3794784.0, "gdp": 20966.529, "gini_1990": 43.113998, "gini_2000": 46.201, "gini_2010": 45.951, "gini_2019": 40.207001, "gini_2022": 36.389999, "interpolated": "No"}, {"country": "Germany", "c3": "DEU", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 84086224.0, "gdp": 63353.941, "gini_1990": 28.641001, "gini_2000": 29.112, "gini_2010": 30.492001, "gini_2019": 31.879, "gini_2022": 30.599001, "interpolated": "No"}, {"country": "Ghana", "c3": "GHA", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 33149152.0, "gdp": 6729.27, "gini_1990": 51.826, "gini_2000": 54.651001, "gini_2010": 56.325001, "gini_2019": 57.083, "gini_2022": 57.083, "interpolated": "Extrapolated"}, {"country": "Greece", "c3": "GRC", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 10412480.0, "gdp": 35956.25, "gini_1990": 34.923, "gini_2000": 34.928001, "gini_2010": 33.644001, "gini_2019": 32.269001, "gini_2022": 32.306999, "interpolated": "No"}, {"country": "Greenland", "c3": "GRL", "region_wb": "Europe and Central Asia", "region_un": "Americas", "incomegroup": "High income", "population": 55990.0, "gdp": 70865.438, "gini_1990": 34.092999, "gini_2000": 34.092999, "gini_2010": 34.178001, "gini_2019": 35.917999, "gini_2022": 35.917999, "interpolated": "Extrapolated"}, {"country": "Grenada", "c3": "GRD", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 116913.0, "gdp": 16386.461, "gini_1990": 47.195, "gini_2000": 47.195, "gini_2010": 47.195, "gini_2019": 47.195, "gini_2022": 47.195, "interpolated": "Extrapolated"}, {"country": "Guatemala", "c3": "GTM", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 17847876.0, "gdp": 12153.03, "gini_1990": 58.098, "gini_2000": 53.875999, "gini_2010": 52.007999, "gini_2019": 47.917, "gini_2022": 47.917, "interpolated": "Extrapolated"}, {"country": "Guinea", "c3": "GIN", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 14055137.0, "gdp": 3792.01, "gini_1990": 57.859001, "gini_2000": 57.472, "gini_2010": 51.160999, "gini_2019": 46.194, "gini_2022": 46.194, "interpolated": "Extrapolated"}, {"country": "Guinea-Bissau", "c3": "GNB", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 2105529.0, "gdp": 2507.01, "gini_1990": 65.841003, "gini_2000": 52.214001, "gini_2010": 62.553001, "gini_2019": 50.191002, "gini_2022": 49.195999, "interpolated": "No"}, {"country": "Guyana", "c3": "GUY", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "High income", "population": 821637.0, "gdp": 37068.199, "gini_1990": 51.629002, "gini_2000": 44.851002, "gini_2010": 44.851002, "gini_2019": 44.851002, "gini_2022": 44.851002, "interpolated": "Extrapolated"}, {"country": "Haiti", "c3": "HTI", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Lower middle income", "population": 11503606.0, "gdp": 3047.6499, "gini_1990": 58.708, "gini_2000": 58.708, "gini_2010": 60.007999, "gini_2019": 60.297001, "gini_2022": 60.297001, "interpolated": "Extrapolated"}, {"country": "Honduras", "c3": "HND", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Lower middle income", "population": 10463872.0, "gdp": 6352.5898, "gini_1990": 56.84, "gini_2000": 52.312, "gini_2010": 51.441002, "gini_2019": 48.979, "gini_2022": 48.979, "interpolated": "Extrapolated"}, {"country": "Hong Kong", "c3": "HKG", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "High income", "population": 7465915.0, "gdp": 64036.789, "gini_1990": 32.960999, "gini_2000": 40.228001, "gini_2010": 40.993, "gini_2019": 40.888, "gini_2022": 40.888, "interpolated": "Extrapolated"}, {"country": "Hungary", "c3": "HUN", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 9684306.0, "gdp": 40693.961, "gini_1990": 27.040001, "gini_2000": 30.205999, "gini_2010": 29.715, "gini_2019": 26.874001, "gini_2022": 26.472, "interpolated": "No"}, {"country": "Iceland", "c3": "ISL", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 380356.0, "gdp": 65932.133, "gini_1990": 26.698999, "gini_2000": 26.698999, "gini_2010": 27.223, "gini_2019": 26.709, "gini_2022": 26.709, "interpolated": "Extrapolated"}, {"country": "India", "c3": "IND", "region_wb": "South Asia", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 1425423232.0, "gdp": 8544.6904, "gini_1990": 46.112, "gini_2000": 49.625999, "gini_2010": 51.161999, "gini_2019": 50.766998, "gini_2022": 48.983002, "interpolated": "No"}, {"country": "Indonesia", "c3": "IDN", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 278830528.0, "gdp": 13334.29, "gini_1990": 34.243, "gini_2000": 33.646999, "gini_2010": 37.025002, "gini_2019": 37.66, "gini_2022": 37.764999, "interpolated": "No"}, {"country": "Iran", "c3": "IRN", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 89524240.0, "gdp": 15331.33, "gini_1990": 41.575001, "gini_2000": 41.874001, "gini_2010": 40.375999, "gini_2019": 36.653, "gini_2022": 35.183998, "interpolated": "No"}, {"country": "Iraq", "c3": "IRQ", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 44070552.0, "gdp": 13393.67, "gini_1990": 42.839001, "gini_2000": 38.792, "gini_2010": 40.936001, "gini_2019": 40.783001, "gini_2022": 40.783001, "interpolated": "Extrapolated"}, {"country": "Ireland", "c3": "IRL", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 5110016.0, "gdp": 124991.3, "gini_1990": 36.199001, "gini_2000": 33.846001, "gini_2010": 32.861, "gini_2019": 30.290001, "gini_2022": 30.697001, "interpolated": "No"}, {"country": "Israel", "c3": "ISR", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "High income", "population": 9103151.0, "gdp": 48271.422, "gini_1990": 35.987999, "gini_2000": 38.827, "gini_2010": 42.587002, "gini_2019": 38.377998, "gini_2022": 38.134998, "interpolated": "Extrapolated"}, {"country": "Italy", "c3": "ITA", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 59619112.0, "gdp": 52924.609, "gini_1990": 31.582001, "gini_2000": 35.216999, "gini_2010": 34.756001, "gini_2019": 36.021, "gini_2022": 35.644001, "interpolated": "No"}, {"country": "Jamaica", "c3": "JAM", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 2839144.0, "gdp": 10072.05, "gini_1990": 51.807999, "gini_2000": 48.278, "gini_2010": 48.526001, "gini_2019": 47.445999, "gini_2022": 47.445999, "interpolated": "Extrapolated"}, {"country": "Japan", "c3": "JPN", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "High income", "population": 124997576.0, "gdp": 45174.73, "gini_1990": 32.354, "gini_2000": 33.613998, "gini_2010": 33.064999, "gini_2019": 32.936001, "gini_2022": 32.368999, "interpolated": "Extrapolated"}, {"country": "Jordan", "c3": "JOR", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 11256263.0, "gdp": 9266.5801, "gini_1990": 44.919998, "gini_2000": 41.362, "gini_2010": 41.743, "gini_2019": 40.042999, "gini_2022": 40.042999, "interpolated": "Extrapolated"}, {"country": "Kazakhstan", "c3": "KAZ", "region_wb": "Europe and Central Asia", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 20034610.0, "gdp": 33506.262, "gini_1990": 32.675999, "gini_2000": 42.222, "gini_2010": 35.883999, "gini_2019": 35.874001, "gini_2022": 36.881001, "interpolated": "Extrapolated"}, {"country": "Kenya", "c3": "KEN", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 54252460.0, "gdp": 5491.6899, "gini_1990": 65.577003, "gini_2000": 58.486, "gini_2010": 57.518002, "gini_2019": 52.172001, "gini_2022": 53.202999, "interpolated": "Extrapolated"}, {"country": "Kiribati", "c3": "KIR", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "Lower middle income", "population": 130468.9921875, "gdp": 3117.76, "gini_1990": 39.202999, "gini_2000": 39.202999, "gini_2010": 37.112, "gini_2019": 32.408001, "gini_2022": 31.885, "interpolated": "Extrapolated"}, {"country": "Korea, Republic of", "c3": "KOR", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "High income", "population": 51782512.0, "gdp": 49933.98, "gini_1990": 34.592999, "gini_2000": 35.130001, "gini_2010": 32.375999, "gini_2019": 33.223999, "gini_2022": 32.976002, "interpolated": "Extrapolated"}, {"country": "Kosovo", "c3": "XKX", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "Upper middle income", "population": 1717946.0, "gdp": 13022.46, "gini_1990": 28.179001, "gini_2000": 32.087002, "gini_2010": 34.431, "gini_2019": 29.305, "gini_2022": 29.305, "interpolated": "Extrapolated"}, {"country": "Kuwait", "c3": "KWT", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "High income", "population": 4589511.0, "gdp": 50984.301, "gini_1990": 39.511002, "gini_2000": 40.41, "gini_2010": 40.41, "gini_2019": 40.41, "gini_2022": 40.41, "interpolated": "Extrapolated"}, {"country": "Kyrgyzstan", "c3": "KGZ", "region_wb": "Europe and Central Asia", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 6955788.0, "gdp": 6139.7798, "gini_1990": 46.077999, "gini_2000": 33.298, "gini_2010": 32.528, "gini_2019": 32.067001, "gini_2022": 29.695, "interpolated": "No"}, {"country": "Laos", "c3": "LAO", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 7559007.0, "gdp": 8183.0298, "gini_1990": 36.993, "gini_2000": 36.716, "gini_2010": 38.008999, "gini_2019": 40.561001, "gini_2022": 40.561001, "interpolated": "Extrapolated"}, {"country": "Latvia", "c3": "LVA", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 1881063.0, "gdp": 36348.809, "gini_1990": 27.002001, "gini_2000": 33.576, "gini_2010": 36.141998, "gini_2019": 35.271999, "gini_2022": 34.536999, "interpolated": "No"}, {"country": "Lebanon", "c3": "LBN", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 5744489.0, "gdp": 11474.75, "gini_1990": 44.23, "gini_2000": 40.953999, "gini_2010": 37.678001, "gini_2019": 37.021999, "gini_2022": 37.021999, "interpolated": "Extrapolated"}, {"country": "Lesotho", "c3": "LSO", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 2286110.0, "gdp": 2577.55, "gini_1990": 68.132004, "gini_2000": 65.953003, "gini_2010": 64.856003, "gini_2019": 58.113998, "gini_2022": 58.113998, "interpolated": "Extrapolated"}, {"country": "Liberia", "c3": "LBR", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 5373294.0, "gdp": 1579.0, "gini_1990": 51.573002, "gini_2000": 51.573002, "gini_2010": 50.499001, "gini_2019": 50.679001, "gini_2022": 50.679001, "interpolated": "Extrapolated"}, {"country": "Libya", "c3": "LBY", "region_wb": "Middle East and North Africa", "region_un": "Africa", "incomegroup": "Upper middle income", "population": 7223805.0, "gdp": 11456.08, "gini_1990": 40.442001, "gini_2000": 39.076, "gini_2010": 37.813999, "gini_2019": 35.695999, "gini_2022": 34.973999, "interpolated": "Extrapolated"}, {"country": "Lithuania", "c3": "LTU", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 2816919.0, "gdp": 47238.102, "gini_1990": 32.957001, "gini_2000": 34.866001, "gini_2010": 36.512001, "gini_2019": 35.424, "gini_2022": 36.633999, "interpolated": "No"}, {"country": "Luxembourg", "c3": "LUX", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 653313.0, "gdp": 137059.19, "gini_1990": 27.055, "gini_2000": 29.945, "gini_2010": 30.783001, "gini_2019": 34.827, "gini_2022": 33.359001, "interpolated": "No"}, {"country": "Madagascar", "c3": "MDG", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 30437262.0, "gdp": 1622.61, "gini_1990": 58.558998, "gini_2000": 56.734001, "gini_2010": 56.124001, "gini_2019": 56.411999, "gini_2022": 56.411999, "interpolated": "Extrapolated"}, {"country": "Malawi", "c3": "MWI", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 20568728.0, "gdp": 1659.96, "gini_1990": 61.903999, "gini_2000": 67.314003, "gini_2010": 57.743, "gini_2019": 54.584999, "gini_2022": 53.136002, "interpolated": "Extrapolated"}, {"country": "Malaysia", "c3": "MYS", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 34695492.0, "gdp": 32079.15, "gini_1990": 46.456001, "gini_2000": 47.785, "gini_2010": 45.368, "gini_2019": 41.066002, "gini_2022": 40.534, "interpolated": "No"}, {"country": "Maldives", "c3": "MDV", "region_wb": "South Asia", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 524106.03125, "gdp": 21357.811, "gini_1990": 52.925999, "gini_2000": 52.925999, "gini_2010": 51.073002, "gini_2019": 44.550999, "gini_2022": 44.179001, "interpolated": "Extrapolated"}, {"country": "Mali", "c3": "MLI", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 23072640.0, "gdp": 2357.1899, "gini_1990": 54.194, "gini_2000": 57.02, "gini_2010": 50.229, "gini_2019": 36.005001, "gini_2022": 39.060001, "interpolated": "Extrapolated"}, {"country": "Malta", "c3": "MLT", "region_wb": "Middle East and North Africa", "region_un": "Europe", "incomegroup": "High income", "population": 528192.0, "gdp": 59133.77, "gini_1990": 28.754, "gini_2000": 28.754, "gini_2010": 30.365, "gini_2019": 28.75, "gini_2022": 31.618999, "interpolated": "No"}, {"country": "Marshall Islands", "c3": "MHL", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "Upper middle income", "population": 40077.0, "gdp": 6844.3301, "gini_1990": 37.855, "gini_2000": 37.855, "gini_2010": 37.855, "gini_2019": 37.855, "gini_2022": 37.855, "interpolated": "Extrapolated"}, {"country": "Mauritania", "c3": "MRT", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 4875637.0, "gdp": 6053.2598, "gini_1990": 59.348999, "gini_2000": 53.362999, "gini_2010": 50.452999, "gini_2019": 48.136002, "gini_2022": 48.044998, "interpolated": "Extrapolated"}, {"country": "Mauritius", "c3": "MUS", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Upper middle income", "population": 1276130.0, "gdp": 24831.369, "gini_1990": 45.486, "gini_2000": 45.486, "gini_2010": 46.838001, "gini_2019": 46.449001, "gini_2022": 46.449001, "interpolated": "Extrapolated"}, {"country": "Mexico", "c3": "MEX", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 128613120.0, "gdp": 21643.971, "gini_1990": 52.118, "gini_2000": 53.312, "gini_2010": 48.943001, "gini_2019": 45.987, "gini_2022": 43.918999, "interpolated": "No"}, {"country": "Micronesia, Federated States of", "c3": "FSM", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "Lower middle income", "population": 112114.0, "gdp": 3874.2, "gini_1990": 62.798, "gini_2000": 62.798, "gini_2010": 42.268002, "gini_2019": 41.629002, "gini_2022": 41.629002, "interpolated": "Extrapolated"}, {"country": "Moldova", "c3": "MDA", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "Upper middle income", "population": 3039985.0, "gdp": 15291.13, "gini_1990": 36.514, "gini_2000": 42.598, "gini_2010": 39.174, "gini_2019": 34.433998, "gini_2022": 34.185001, "interpolated": "Extrapolated"}, {"country": "Mongolia", "c3": "MNG", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 3386015.0, "gdp": 15310.43, "gini_1990": 36.075001, "gini_2000": 34.615002, "gini_2010": 35.910999, "gini_2019": 35.387001, "gini_2022": 34.627998, "interpolated": "No"}, {"country": "Montenegro", "c3": "MNE", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "Upper middle income", "population": 614648.0, "gdp": 26164.631, "gini_1990": 28.179001, "gini_2000": 32.087002, "gini_2010": 33.116001, "gini_2019": 35.213001, "gini_2022": 33.966999, "interpolated": "Extrapolated"}, {"country": "Morocco", "c3": "MAR", "region_wb": "Middle East and North Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 37329064.0, "gdp": 8666.0801, "gini_1990": 42.417999, "gini_2000": 43.450001, "gini_2010": 43.631001, "gini_2019": 43.120998, "gini_2022": 43.120998, "interpolated": "Extrapolated"}, {"country": "Mozambique", "c3": "MOZ", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 32656246.0, "gdp": 1476.67, "gini_1990": 59.473999, "gini_2000": 60.151001, "gini_2010": 61.504002, "gini_2019": 62.703999, "gini_2022": 62.159, "interpolated": "Extrapolated"}, {"country": "Myanmar", "c3": "MMR", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 53756784.0, "gdp": 5350.48, "gini_1990": 36.507999, "gini_2000": 37.827, "gini_2010": 39.146, "gini_2019": 34.125999, "gini_2022": 34.125999, "interpolated": "Extrapolated"}, {"country": "Namibia", "c3": "NAM", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Upper middle income", "population": 2889662.0, "gdp": 9948.46, "gini_1990": 73.188004, "gini_2000": 68.25, "gini_2010": 63.033001, "gini_2019": 61.765999, "gini_2022": 61.765999, "interpolated": "Extrapolated"}, {"country": "Nauru", "c3": "NRU", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "High income", "population": 11801.0, "gdp": 12467.35, "gini_1990": 35.119999, "gini_2000": 35.119999, "gini_2010": 35.119999, "gini_2019": 35.119999, "gini_2022": 35.119999, "interpolated": "Extrapolated"}, {"country": "Nepal", "c3": "NPL", "region_wb": "South Asia", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 29715436.0, "gdp": 4763.3901, "gini_1990": 49.438999, "gini_2000": 51.838001, "gini_2010": 47.888, "gini_2019": 46.68, "gini_2022": 46.68, "interpolated": "Extrapolated"}, {"country": "Netherlands", "c3": "NLD", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 17904422.0, "gdp": 72103.867, "gini_1990": 30.478001, "gini_2000": 28.094, "gini_2010": 28.903, "gini_2019": 28.423, "gini_2022": 26.108999, "interpolated": "No"}, {"country": "New Zealand", "c3": "NZL", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "High income", "population": 5131734.0, "gdp": 49474.238, "gini_1990": 31.033001, "gini_2000": 33.910999, "gini_2010": 33.192001, "gini_2019": 34.779999, "gini_2022": 34.779999, "interpolated": "Extrapolated"}, {"country": "Nicaragua", "c3": "NIC", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Lower middle income", "population": 6730654.0, "gdp": 7258.6802, "gini_1990": 56.633999, "gini_2000": 56.419998, "gini_2010": 46.722, "gini_2019": 49.130001, "gini_2022": 49.130001, "interpolated": "Extrapolated"}, {"country": "Niger", "c3": "NER", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 25311972.0, "gdp": 1717.52, "gini_1990": 49.849998, "gini_2000": 56.473999, "gini_2010": 49.057999, "gini_2019": 52.092999, "gini_2022": 48.631001, "interpolated": "No"}, {"country": "Nigeria", "c3": "NGA", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 223150896.0, "gdp": 5552.8398, "gini_1990": 54.064999, "gini_2000": 47.118999, "gini_2010": 36.787998, "gini_2019": 35.595001, "gini_2022": 35.595001, "interpolated": "Extrapolated"}, {"country": "North Macedonia", "c3": "MKD", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "Upper middle income", "population": 1840233.0, "gdp": 23056.5, "gini_1990": 28.179001, "gini_2000": 37.402, "gini_2010": 42.615002, "gini_2019": 32.674, "gini_2022": 33.242001, "interpolated": "Extrapolated"}, {"country": "Norway", "c3": "NOR", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 5456801.0, "gdp": 91068.602, "gini_1990": 25.08, "gini_2000": 27.365, "gini_2010": 26.525, "gini_2019": 27.326, "gini_2022": 29.34, "interpolated": "Extrapolated"}, {"country": "Oman", "c3": "OMN", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "High income", "population": 4730226.0, "gdp": 40366.461, "gini_1990": 43.651001, "gini_2000": 43.651001, "gini_2010": 40.091, "gini_2019": 39.735001, "gini_2022": 39.735001, "interpolated": "Extrapolated"}, {"country": "Pakistan", "c3": "PAK", "region_wb": "South Asia", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 243700672.0, "gdp": 5526.2798, "gini_1990": 46.543999, "gini_2000": 45.644001, "gini_2010": 43.647999, "gini_2019": 44.063, "gini_2022": 44.063, "interpolated": "Extrapolated"}, {"country": "Palau", "c3": "PLW", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "High income", "population": 17759.0, "gdp": 15477.55, "gini_1990": 43.34, "gini_2000": 43.34, "gini_2010": 43.34, "gini_2019": 43.34, "gini_2022": 43.34, "interpolated": "Extrapolated"}, {"country": "Panama", "c3": "PAN", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "High income", "population": 4400773.0, "gdp": 33833.031, "gini_1990": 56.016998, "gini_2000": 56.400002, "gini_2010": 51.158001, "gini_2019": 50.731998, "gini_2022": 49.695999, "interpolated": "No"}, {"country": "Papua New Guinea", "c3": "PNG", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "Lower middle income", "population": 10203169.0, "gdp": 4125.4902, "gini_1990": 46.099998, "gini_2000": 45.236, "gini_2010": 43.076, "gini_2019": 43.076, "gini_2022": 43.076, "interpolated": "Extrapolated"}, {"country": "Paraguay", "c3": "PRY", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 6760464.0, "gdp": 15259.15, "gini_1990": 51.719002, "gini_2000": 56.911999, "gini_2010": 53.505001, "gini_2019": 48.070999, "gini_2022": 48.194, "interpolated": "No"}, {"country": "Peru", "c3": "PER", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 33475438.0, "gdp": 15548.93, "gini_1990": 52.741001, "gini_2000": 47.937, "gini_2010": 49.439999, "gini_2019": 42.683998, "gini_2022": 41.238998, "interpolated": "No"}, {"country": "Philippines", "c3": "PHL", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 113964336.0, "gdp": 9457.0996, "gini_1990": 47.512001, "gini_2000": 47.435001, "gini_2010": 46.219002, "gini_2019": 41.564999, "gini_2022": 40.506001, "interpolated": "Extrapolated"}, {"country": "Poland", "c3": "POL", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 38385740.0, "gdp": 44160.859, "gini_1990": 28.854, "gini_2000": 33.206001, "gini_2010": 34.611, "gini_2019": 30.916, "gini_2022": 31.492001, "interpolated": "No"}, {"country": "Portugal", "c3": "PRT", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 10417073.0, "gdp": 41288.051, "gini_1990": 32.915001, "gini_2000": 37.452999, "gini_2010": 34.793999, "gini_2019": 33.458, "gini_2022": 34.591999, "interpolated": "No"}, {"country": "Puerto Rico", "c3": "PRI", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "High income", "population": 3240968.0, "gdp": 42562.379, "gini_1990": 51.216999, "gini_2000": 54.094002, "gini_2010": 52.737, "gini_2019": 52.737, "gini_2022": 52.737, "interpolated": "Extrapolated"}, {"country": "Qatar", "c3": "QAT", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "High income", "population": 2892455.0, "gdp": 114740.13, "gini_1990": 36.994999, "gini_2000": 38.004002, "gini_2010": 38.280998, "gini_2019": 34.674999, "gini_2022": 34.509998, "interpolated": "Extrapolated"}, {"country": "Romania", "c3": "ROU", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 19166772.0, "gdp": 39733.66, "gini_1990": 24.042999, "gini_2000": 32.888, "gini_2010": 35.632999, "gini_2019": 35.949001, "gini_2022": 34.131001, "interpolated": "No"}, {"country": "Russia", "c3": "RUS", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 145579904.0, "gdp": 38263.621, "gini_1990": 36.655998, "gini_2000": 42.582001, "gini_2010": 34.563, "gini_2019": 34.633999, "gini_2022": 34.178001, "interpolated": "No"}, {"country": "Rwanda", "c3": "RWA", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 13651030.0, "gdp": 2889.8799, "gini_1990": 50.325001, "gini_2000": 59.869999, "gini_2010": 60.526001, "gini_2019": 57.167, "gini_2022": 57.167, "interpolated": "Extrapolated"}, {"country": "Saint Kitts and Nevis", "c3": "KNA", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "High income", "population": 46709.0, "gdp": 29761.279, "gini_1990": 50.998001, "gini_2000": 52.665001, "gini_2010": 49.035999, "gini_2019": 48.848999, "gini_2022": 46.860001, "interpolated": "Extrapolated"}, {"country": "Saint Lucia", "c3": "LCA", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 178781.0, "gdp": 22961.961, "gini_1990": 42.466, "gini_2000": 44.492001, "gini_2010": 48.544998, "gini_2019": 50.977001, "gini_2022": 50.977001, "interpolated": "Extrapolated"}, {"country": "Saint Vincent and the Grenadines", "c3": "VCT", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 102046.0, "gdp": 17172.211, "gini_1990": 52.411999, "gini_2000": 52.637001, "gini_2010": 49.193001, "gini_2019": 47.589001, "gini_2022": 46.047001, "interpolated": "Extrapolated"}, {"country": "Samoa", "c3": "WSM", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "Lower middle income", "population": 215261.0, "gdp": 5843.77, "gini_1990": 42.053001, "gini_2000": 42.053001, "gini_2010": 42.216999, "gini_2019": 40.57, "gini_2022": 40.57, "interpolated": "Extrapolated"}, {"country": "San Marino", "c3": "SMR", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 34090.0, "gdp": 70887.57, "gini_1990": 31.535999, "gini_2000": 34.695, "gini_2010": 33.166, "gini_2019": 32.952999, "gini_2022": 32.333, "interpolated": "Extrapolated"}, {"country": "Sao Tome and Principe", "c3": "STP", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 226305.0, "gdp": 5632.1401, "gini_1990": 48.106998, "gini_2000": 48.106998, "gini_2010": 47.126999, "gini_2019": 54.828999, "gini_2022": 54.828999, "interpolated": "Extrapolated"}, {"country": "Saudi Arabia", "c3": "SAU", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "High income", "population": 32175352.0, "gdp": 57351.879, "gini_1990": 36.994999, "gini_2000": 38.004002, "gini_2010": 38.280998, "gini_2019": 34.674999, "gini_2022": 34.509998, "interpolated": "Extrapolated"}, {"country": "Senegal", "c3": "SEN", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 17651104.0, "gdp": 4227.73, "gini_1990": 64.532997, "gini_2000": 54.639, "gini_2010": 54.311001, "gini_2019": 52.910999, "gini_2022": 51.203999, "interpolated": "No"}, {"country": "Serbia", "c3": "SRB", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "Upper middle income", "population": 6791213.0, "gdp": 24910.42, "gini_1990": 28.179001, "gini_2000": 32.087002, "gini_2010": 34.238998, "gini_2019": 31.261999, "gini_2022": 31.715, "interpolated": "No"}, {"country": "Seychelles", "c3": "SYC", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "High income", "population": 125522.0, "gdp": 28540.76, "gini_1990": 53.798, "gini_2000": 53.798, "gini_2010": 49.938, "gini_2019": 32.026001, "gini_2022": 32.026001, "interpolated": "Extrapolated"}, {"country": "Sierra Leone", "c3": "SLE", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 8276806.5, "gdp": 2934.03, "gini_1990": 70.681, "gini_2000": 59.126999, "gini_2010": 50.383999, "gini_2019": 50.895, "gini_2022": 50.895, "interpolated": "Extrapolated"}, {"country": "Singapore", "c3": "SGP", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "High income", "population": 5649885.0, "gdp": 132468.94, "gini_1990": 43.487, "gini_2000": 43.487, "gini_2010": 38.715, "gini_2019": 40.236, "gini_2022": 40.236, "interpolated": "Extrapolated"}, {"country": "Slovakia", "c3": "SVK", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 5473197.0, "gdp": 38720.48, "gini_1990": 21.618999, "gini_2000": 26.547001, "gini_2010": 26.440001, "gini_2019": 24.987, "gini_2022": 24.172001, "interpolated": "No"}, {"country": "Slovenia", "c3": "SVN", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 2115228.0, "gdp": 47433.398, "gini_1990": 28.179001, "gini_2000": 24.055, "gini_2010": 25.049, "gini_2019": 25.427999, "gini_2022": 25.066, "interpolated": "No"}, {"country": "Solomon Islands", "c3": "SLB", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "Lower middle income", "population": 781066.0, "gdp": 2517.9299, "gini_1990": 46.250999, "gini_2000": 46.250999, "gini_2010": 42.236, "gini_2019": 39.224998, "gini_2022": 39.224998, "interpolated": "Extrapolated"}, {"country": "Somalia", "c3": "SOM", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 17801896.0, "gdp": 1387.8101, "gini_1990": 47.381001, "gini_2000": 47.381001, "gini_2010": 51.625999, "gini_2019": 54.810001, "gini_2022": 54.810001, "interpolated": "Extrapolated"}, {"country": "South Africa", "c3": "ZAF", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Upper middle income", "population": 62378412.0, "gdp": 13777.19, "gini_1990": 68.786003, "gini_2000": 67.805, "gini_2010": 72.877998, "gini_2019": 66.918999, "gini_2022": 66.918999, "interpolated": "Extrapolated"}, {"country": "South Sudan", "c3": "SSD", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 11021177.0, "gdp": 3132.0801, "gini_1990": 53.914001, "gini_2000": 56.744999, "gini_2010": 59.077, "gini_2019": 57.563, "gini_2022": 57.563, "interpolated": "Extrapolated"}, {"country": "Spain", "c3": "ESP", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 47828384.0, "gdp": 46479.09, "gini_1990": 32.396, "gini_2000": 34.405998, "gini_2010": 35.041, "gini_2019": 34.797001, "gini_2022": 33.889999, "interpolated": "No"}, {"country": "Sri Lanka", "c3": "LKA", "region_wb": "South Asia", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 22834964.0, "gdp": 13249.41, "gini_1990": 51.008999, "gini_2000": 52.27, "gini_2010": 54.674999, "gini_2019": 50.444, "gini_2022": 50.444, "interpolated": "Extrapolated"}, {"country": "Sudan", "c3": "SDN", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 49383348.0, "gdp": 3132.0801, "gini_1990": 51.529999, "gini_2000": 53.227001, "gini_2010": 54.493, "gini_2019": 53.449001, "gini_2022": 53.449001, "interpolated": "Extrapolated"}, {"country": "Suriname", "c3": "SUR", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Upper middle income", "population": 623164.0, "gdp": 18742.59, "gini_1990": 51.665001, "gini_2000": 57.34, "gini_2010": 57.34, "gini_2019": 57.34, "gini_2022": 57.34, "interpolated": "Extrapolated"}, {"country": "Sweden", "c3": "SWE", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 10487338.0, "gdp": 63611.359, "gini_1990": 24.299999, "gini_2000": 27.011, "gini_2010": 28.128, "gini_2019": 30.569, "gini_2022": 31.68, "interpolated": "No"}, {"country": "Switzerland", "c3": "CHE", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 8792182.0, "gdp": 83007.281, "gini_1990": 35.757999, "gini_2000": 33.553001, "gini_2010": 33.151001, "gini_2019": 33.365002, "gini_2022": 33.806999, "interpolated": "No"}, {"country": "Syria", "c3": "SYR", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "Low income", "population": 22462174.0, "gdp": 4454.8501, "gini_1990": 36.955002, "gini_2000": 37.693001, "gini_2010": 35.116001, "gini_2019": 35.116001, "gini_2022": 35.116001, "interpolated": "Extrapolated"}, {"country": "Taiwan", "c3": "TWN", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "High income", "population": 23420112.0, "gdp": 63771.762, "gini_1990": 29.874001, "gini_2000": 31.091999, "gini_2010": 33.216, "gini_2019": 31.205, "gini_2022": 31.573999, "interpolated": "Extrapolated"}, {"country": "Tajikistan", "c3": "TJK", "region_wb": "Europe and Central Asia", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 10182222.0, "gdp": 4213.7598, "gini_1990": 32.150002, "gini_2000": 32.758999, "gini_2010": 33.459999, "gini_2019": 35.566002, "gini_2022": 35.566002, "interpolated": "Extrapolated"}, {"country": "Tanzania", "c3": "TZA", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 64711820.0, "gdp": 3546.98, "gini_1990": 51.237, "gini_2000": 51.980999, "gini_2010": 53.248001, "gini_2019": 54.536999, "gini_2022": 54.536999, "interpolated": "Extrapolated"}, {"country": "Thailand", "c3": "THA", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 71735328.0, "gdp": 20741.52, "gini_1990": 45.346001, "gini_2000": 43.549999, "gini_2010": 40.887001, "gini_2019": 37.327, "gini_2022": 37.335999, "interpolated": "Extrapolated"}, {"country": "Timor-Leste", "c3": "TLS", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 1369295.0, "gdp": 5344.1401, "gini_1990": 38.341999, "gini_2000": 38.341999, "gini_2010": 32.138, "gini_2019": 32.540001, "gini_2022": 32.540001, "interpolated": "Extrapolated"}, {"country": "Togo", "c3": "TGO", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 9089738.0, "gdp": 2662.26, "gini_1990": 56.104, "gini_2000": 56.104, "gini_2010": 58.466, "gini_2019": 56.334, "gini_2022": 52.651001, "interpolated": "No"}, {"country": "Tonga", "c3": "TON", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "Upper middle income", "population": 105042.0, "gdp": 6901.7402, "gini_1990": 39.553001, "gini_2000": 39.553001, "gini_2010": 38.883999, "gini_2019": 32.890999, "gini_2022": 31.202999, "interpolated": "Extrapolated"}, {"country": "Trinidad and Tobago", "c3": "TTO", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "High income", "population": 1495921.0, "gdp": 31323.279, "gini_1990": 41.404999, "gini_2000": 40.172001, "gini_2010": 40.172001, "gini_2019": 40.172001, "gini_2022": 40.172001, "interpolated": "Extrapolated"}, {"country": "Tunisia", "c3": "TUN", "region_wb": "Middle East and North Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 12119334.0, "gdp": 12632.04, "gini_1990": 46.722, "gini_2000": 47.282001, "gini_2010": 42.951, "gini_2019": 40.369999, "gini_2022": 40.674, "interpolated": "No"}, {"country": "Turkiye", "c3": "TUR", "region_wb": "Europe and Central Asia", "region_un": "", "incomegroup": "Upper middle income", "population": 87058480.0, "gdp": 33061.051, "gini_1990": 46.654999, "gini_2000": 46.856998, "gini_2010": 44.466999, "gini_2019": 43.085999, "gini_2022": 45.880001, "interpolated": "No"}, {"country": "Turkmenistan", "c3": "TKM", "region_wb": "Europe and Central Asia", "region_un": "Asia", "incomegroup": "Upper middle income", "population": 7230193.0, "gdp": 17119.57, "gini_1990": 35.779999, "gini_2000": 46.015999, "gini_2010": 46.015999, "gini_2019": 46.015999, "gini_2022": 46.015999, "interpolated": "Extrapolated"}, {"country": "Turks and Caicos Islands", "c3": "TCA", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "High income", "population": 45847.0, "gdp": 22209.91, "gini_1990": 50.998001, "gini_2000": 52.665001, "gini_2010": 49.035999, "gini_2019": 48.848999, "gini_2022": 46.860001, "interpolated": "Extrapolated"}, {"country": "Tuvalu", "c3": "TUV", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "Upper middle income", "population": 9992.0, "gdp": 5498.1802, "gini_1990": 40.619999, "gini_2000": 40.619999, "gini_2010": 40.619999, "gini_2019": 40.619999, "gini_2022": 40.619999, "interpolated": "Extrapolated"}, {"country": "Uganda", "c3": "UGA", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Low income", "population": 47312720.0, "gdp": 2724.9099, "gini_1990": 57.236, "gini_2000": 56.641998, "gini_2010": 57.537998, "gini_2019": 56.362999, "gini_2022": 56.328999, "interpolated": "Extrapolated"}, {"country": "Ukraine", "c3": "UKR", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "Upper middle income", "population": 41048764.0, "gdp": 13787.12, "gini_1990": 30.351, "gini_2000": 36.773998, "gini_2010": 33.502998, "gini_2019": 34.938, "gini_2022": 34.063, "interpolated": "Extrapolated"}, {"country": "United Arab Emirates", "c3": "ARE", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "High income", "population": 10242086.0, "gdp": 68867.828, "gini_1990": 32.587002, "gini_2000": 32.587002, "gini_2010": 32.587002, "gini_2019": 26.381001, "gini_2022": 26.381001, "interpolated": "Extrapolated"}, {"country": "United Kingdom", "c3": "GBR", "region_wb": "Europe and Central Asia", "region_un": "Europe", "incomegroup": "High income", "population": 68179312.0, "gdp": 54805.449, "gini_1990": 34.317001, "gini_2000": 36.714001, "gini_2010": 35.115002, "gini_2019": 33.692001, "gini_2022": 32.483002, "interpolated": "No"}, {"country": "United States", "c3": "USA", "region_wb": "North America", "region_un": "Americas", "incomegroup": "High income", "population": 341534016.0, "gdp": 72841.922, "gini_1990": 37.919998, "gini_2000": 39.957001, "gini_2010": 40.823002, "gini_2019": 41.726002, "gini_2022": 39.706001, "interpolated": "No"}, {"country": "Uruguay", "c3": "URY", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "High income", "population": 3390913.0, "gdp": 30879.93, "gini_1990": 43.048, "gini_2000": 43.973, "gini_2010": 44.562, "gini_2019": 40.151001, "gini_2022": 41.339001, "interpolated": "No"}, {"country": "Uzbekistan", "c3": "UZB", "region_wb": "Europe and Central Asia", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 34938952.0, "gdp": 9607.5596, "gini_1990": 29.339001, "gini_2000": 37.085999, "gini_2010": 35.428001, "gini_2019": 34.026001, "gini_2022": 33.558998, "interpolated": "No"}, {"country": "Vanuatu", "c3": "VUT", "region_wb": "East Asia and the Pacific", "region_un": "Oceania", "incomegroup": "Lower middle income", "population": 313046.0, "gdp": 3122.6399, "gini_1990": 39.423, "gini_2000": 39.423, "gini_2010": 39.423, "gini_2019": 35.886002, "gini_2022": 35.493, "interpolated": "Extrapolated"}, {"country": "Venezuela", "c3": "VEN", "region_wb": "Latin America and the Caribbean", "region_un": "Americas", "incomegroup": "Missing", "population": 28213018.0, "gdp": 6320.6299, "gini_1990": 36.98, "gini_2000": 38.854, "gini_2010": 36.365002, "gini_2019": 37.526001, "gini_2022": 37.526001, "interpolated": "Extrapolated"}, {"country": "Vietnam", "c3": "VNM", "region_wb": "East Asia and the Pacific", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 99680656.0, "gdp": 12930.26, "gini_1990": 38.075001, "gini_2000": 38.574001, "gini_2010": 41.841999, "gini_2019": 38.673, "gini_2022": 38.480999, "interpolated": "No"}, {"country": "West Bank and Gaza", "c3": "PSE", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "Lower middle income", "population": 5305270.0, "gdp": 5753.0801, "gini_1990": 40.799999, "gini_2000": 40.972, "gini_2010": 43.502998, "gini_2019": 44.896, "gini_2022": 44.896, "interpolated": "Extrapolated"}, {"country": "Yemen", "c3": "YEM", "region_wb": "Middle East and North Africa", "region_un": "Asia", "incomegroup": "Low income", "population": 38222876.0, "gdp": 2351.1899, "gini_1990": 41.664001, "gini_2000": 38.169998, "gini_2010": 38.702, "gini_2019": 39.493999, "gini_2022": 39.493999, "interpolated": "Extrapolated"}, {"country": "Zambia", "c3": "ZMB", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 20152938.0, "gdp": 3585.1201, "gini_1990": 67.591003, "gini_2000": 59.088001, "gini_2010": 63.605, "gini_2019": 66.321999, "gini_2022": 66.321999, "interpolated": "Extrapolated"}, {"country": "Zimbabwe", "c3": "ZWE", "region_wb": "Sub-Saharan Africa", "region_un": "Africa", "incomegroup": "Lower middle income", "population": 16069056.0, "gdp": 3323.1201, "gini_1990": 72.911003, "gini_2000": 67.856003, "gini_2010": 57.745998, "gini_2019": 57.532001, "gini_2022": 57.532001, "interpolated": "Extrapolated"}];

// ===== CONFIG =====
const REGION_COLORS = {
  'East Asia and the Pacific':          '#3B6D8F',
  'Europe and Central Asia':            '#3A8660',
  'Latin America and the Caribbean':    '#C44536',
  'Middle East and North Africa':       '#C47F17',
  'North America':                      '#5A8E8A',
  'South Asia':                         '#8856A7',
  'Sub-Saharan Africa':                 '#B8860B'
};
const REGION_SHORT = {
  'East Asia and the Pacific':       'East Asia & Pacific',
  'Europe and Central Asia':         'Europe & C. Asia',
  'Latin America and the Caribbean': 'Latin America & Carib.',
  'Middle East and North Africa':    'Middle East & N. Africa',
  'North America':                   'North America',
  'South Asia':                      'South Asia',
  'Sub-Saharan Africa':              'Sub-Saharan Africa'
};
const QUADRANT_DEFS = [
  { id:'low-decline',  label:'Lower & Declining',  sub:'More equal, improving',    color:'#2D7A50', bg:'var(--q-green)', xSide:'low',  ySide:'low'  },
  { id:'low-increase', label:'Lower & Rising',     sub:'More equal, but worsening', color:'#C47F17', bg:'var(--q-yellow)', xSide:'low',  ySide:'high' },
  { id:'high-decline', label:'Higher & Declining',  sub:'Less equal, but improving', color:'#336B99', bg:'var(--q-blue)',  xSide:'high', ySide:'low'  },
  { id:'high-increase',label:'Higher & Rising',     sub:'Less equal, worsening',     color:'#C44536', bg:'var(--q-red)',   xSide:'high', ySide:'high' }
];

// ===== STATE =====
let S = {
  threshold: 40,
  regionFilter: 'all',
  incomeFilter: 'all',
  selectedCountries: new Set(),  // Changed from search: ''
  searchTerm: '',  // Temporary autocomplete query
  sizeBy: 'population',
  baseYear: '1990',
  finalYear: '2022',
  xAxis: 'base',  // 'base' or 'final'
  showLabels: true,
  hiddenRegions: new Set()
};

// ===== URL STATE =====
const DEFAULTS = { threshold:40, regionFilter:'all', incomeFilter:'all', selectedCountries:new Set(), sizeBy:'population', baseYear:'1990', finalYear:'2022', xAxis:'base', showLabels:true };
const VALID_SIZES = new Set(['none','population','gdp']);
const VALID_YEARS = new Set(['1990','2000','2010','2019','2022']);
const YEAR_ORDER = ['1990','2000','2010','2019','2022'];
let TOTAL_COUNT; // cached on first run

function stateToURL() {
  const p = new URLSearchParams();
  if (S.threshold !== DEFAULTS.threshold) p.set('t', S.threshold);
  if (S.regionFilter !== DEFAULTS.regionFilter) p.set('r', S.regionFilter);
  if (S.incomeFilter !== DEFAULTS.incomeFilter) p.set('i', S.incomeFilter);
  if (S.selectedCountries.size > 0) p.set('sc', [...S.selectedCountries].sort().join(','));
  if (S.sizeBy !== DEFAULTS.sizeBy) p.set('s', S.sizeBy);
  if (S.baseYear !== DEFAULTS.baseYear) p.set('by', S.baseYear);
  if (S.finalYear !== DEFAULTS.finalYear) p.set('fy', S.finalYear);
  if (S.xAxis !== DEFAULTS.xAxis) p.set('xa', S.xAxis);
  if (S.showLabels !== DEFAULTS.showLabels) p.set('l', '0');
  if (S.hiddenRegions.size > 0) p.set('hr', [...S.hiddenRegions].map(r => Object.keys(REGION_COLORS).indexOf(r)).join(','));
  if (moverState.region !== 'all') p.set('mr', moverState.region);
  if (moverState.income !== 'all') p.set('mi', moverState.income);
  const hash = p.toString();
  try { history.replaceState(null, '', hash ? '#' + hash : location.pathname + location.search); } catch(e) { /* sandboxed iframe */ }
}

function stateFromURL() {
  const hash = location.hash.slice(1);
  if (!hash) return;
  const p = new URLSearchParams(hash);
  const regionKeys = Object.keys(REGION_COLORS);
  const validRegions = new Set(RAW_DATA.map(d => d.region_wb));
  const validIncomes = new Set(RAW_DATA.map(d => d.incomegroup));

  if (p.has('t')) { const v = parseFloat(p.get('t')); if (v >= 20 && v <= 80) S.threshold = v; }
  if (p.has('r') && (p.get('r') === 'all' || validRegions.has(p.get('r')))) S.regionFilter = p.get('r');
  if (p.has('i') && (p.get('i') === 'all' || validIncomes.has(p.get('i')))) S.incomeFilter = p.get('i');

  // New format: multi-select countries
  if (p.has('sc')) {
    const codes = p.get('sc').split(',').filter(Boolean);
    const validC3s = new Set(RAW_DATA.map(d => d.c3));
    const validCodes = codes.filter(c3 => validC3s.has(c3));
    S.selectedCountries = new Set(validCodes.slice(0, 20));
  }
  // Legacy format: backwards compatibility for old search
  else if (p.has('q')) {
    const query = p.get('q').trim();
    if (query) {
      const match = RAW_DATA.find(d =>
        d.country.toLowerCase() === query.toLowerCase() ||
        d.c3.toLowerCase() === query.toLowerCase()
      );
      if (match) {
        S.selectedCountries = new Set([match.c3]);
      }
    }
  }

  if (p.has('s') && VALID_SIZES.has(p.get('s'))) S.sizeBy = p.get('s');
  if (p.has('by') && VALID_YEARS.has(p.get('by'))) S.baseYear = p.get('by');
  if (p.has('fy') && VALID_YEARS.has(p.get('fy'))) S.finalYear = p.get('fy');
  if (p.has('xa') && (p.get('xa') === 'base' || p.get('xa') === 'final')) S.xAxis = p.get('xa');
  if (p.has('l')) S.showLabels = p.get('l') !== '0';
  if (p.has('hr')) {
    p.get('hr').split(',').forEach(idx => {
      const i = parseInt(idx);
      if (i >= 0 && i < regionKeys.length) S.hiddenRegions.add(regionKeys[i]);
    });
  }
  if (p.has('mr') && (p.get('mr') === 'all' || validRegions.has(p.get('mr')))) moverState.region = p.get('mr');
  if (p.has('mi') && (p.get('mi') === 'all' || validIncomes.has(p.get('mi')))) moverState.income = p.get('mi');
  // Enforce finalYear > baseYear
  if (YEAR_ORDER.indexOf(S.finalYear) <= YEAR_ORDER.indexOf(S.baseYear)) {
    const bi = YEAR_ORDER.indexOf(S.baseYear);
    S.finalYear = bi < YEAR_ORDER.length - 1 ? YEAR_ORDER[bi + 1] : YEAR_ORDER[YEAR_ORDER.length - 1];
    if (YEAR_ORDER.indexOf(S.finalYear) <= YEAR_ORDER.indexOf(S.baseYear)) S.baseYear = YEAR_ORDER[0];
  }
}

function syncUIFromState() {
  document.getElementById('thresholdInput').value = S.threshold;
  document.getElementById('regionFilter').value = S.regionFilter;
  document.getElementById('incomeFilter').value = S.incomeFilter;
  // searchTerm is ephemeral, not synced from URL state
  document.getElementById('sizeBySelect').value = S.sizeBy;
  document.getElementById('baseYearSelect').value = S.baseYear;
  document.getElementById('finalYearSelect').value = S.finalYear;
  document.getElementById('xAxisSelect').value = S.xAxis;
  document.getElementById('labelToggle').checked = S.showLabels;
  document.getElementById('moverRegionFilter').value = moverState.region;
  document.getElementById('moverIncomeFilter').value = moverState.income;
  updateFinalYearOptions();
  updateBaseYearOptions();
  S.hiddenRegions.forEach(r => {
    const el = document.querySelector(`.lr-item[data-region="${r}"]`);
    if (el) el.classList.add('dimmed');
  });
  // Initialize chips after state is loaded
  renderChips();
}

// ===== HELPERS =====
function giniKey(year) { return 'gini_' + year; }
function giniBase(d) { return d[giniKey(S.baseYear)]; }
function giniFinal(d) { return d[giniKey(S.finalYear)]; }
function giniChange(d) { return giniFinal(d) - giniBase(d); }
function xVal(d) { return S.xAxis === 'base' ? giniBase(d) : giniFinal(d); }
function yearLabel() { return `${S.baseYear}\u2013${S.finalYear}`; }

function updateFinalYearOptions() {
  const sel = document.getElementById('finalYearSelect');
  const bi = YEAR_ORDER.indexOf(S.baseYear);
  [...sel.options].forEach(opt => { opt.disabled = YEAR_ORDER.indexOf(opt.value) <= bi; });
}
function updateBaseYearOptions() {
  const sel = document.getElementById('baseYearSelect');
  const fi = YEAR_ORDER.indexOf(S.finalYear);
  [...sel.options].forEach(opt => { opt.disabled = YEAR_ORDER.indexOf(opt.value) >= fi; });
}

// Check if country is selected (replaces isMatch)
function isSelected(d) {
  return S.selectedCountries.has(d.c3);
}

// Fuzzy search for autocomplete
function searchCountries(term) {
  if (!term || term.length < 2) return [];
  const q = term.toLowerCase();
  return RAW_DATA
    .filter(d =>
      d.country.toLowerCase().includes(q) ||
      d.c3.toLowerCase().includes(q) ||
      d.region_wb.toLowerCase().includes(q)
    )
    .slice(0, 10)
    .sort((a, b) => {
      if (a.c3.toLowerCase() === q) return -1;
      if (b.c3.toLowerCase() === q) return 1;
      if (a.country.toLowerCase().startsWith(q)) return -1;
      if (b.country.toLowerCase().startsWith(q)) return 1;
      return a.country.localeCompare(b.country);
    });
}

// Add country to selection
function addCountry(c3) {
  // Validate country exists
  const country = RAW_DATA.find(d => d.c3 === c3);
  if (!country) {
    console.warn(`Invalid country code: ${c3}`);
    return;
  }

  // Check for duplicate
  if (S.selectedCountries.has(c3)) {
    announceToScreenReader(`${country.country} is already selected`);
    return;
  }

  // Check max limit
  if (S.selectedCountries.size >= 20) {
    alert('Maximum 20 countries allowed');
    return;
  }

  S.selectedCountries.add(c3);
  renderChips();
  render(false);
  stateToURL();

  announceToScreenReader(`${country.country} added. ${S.selectedCountries.size} of 20 countries selected.`);
}

// Remove country from selection
function removeCountry(c3) {
  S.selectedCountries.delete(c3);
  renderChips();
  render(false);
  stateToURL();

  const country = RAW_DATA.find(d => d.c3 === c3);
  if (country) {
    announceToScreenReader(`${country.country} removed. ${S.selectedCountries.size} of 20 countries selected.`);
  }
}

// Render chip container
function renderChips() {
  const container = document.getElementById('chipContainer');
  const chipCount = document.getElementById('chipCount');

  // Update count
  chipCount.textContent = `${S.selectedCountries.size} / 20`;
  chipCount.className = 'chip-count';
  if (S.selectedCountries.size >= 19) {
    chipCount.classList.add('max-warning');
  }
  if (S.selectedCountries.size === 20) {
    container.classList.add('at-max');
  } else {
    container.classList.remove('at-max');
  }

  // Clear existing chips (keep label and count)
  const existingChips = container.querySelectorAll('.chip');
  existingChips.forEach(chip => chip.remove());

  // Add chips for selected countries
  const sorted = [...S.selectedCountries]
    .map(c3 => RAW_DATA.find(d => d.c3 === c3))
    .filter(Boolean)
    .sort((a, b) => a.country.localeCompare(b.country));

  sorted.forEach(country => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.dataset.c3 = country.c3;
    chip.setAttribute('role', 'listitem');

    const dot = document.createElement('span');
    dot.className = 'chip-dot';
    dot.style.background = REGION_COLORS[country.region_wb] || '#999';

    const text = document.createElement('span');
    text.className = 'chip-text';
    text.textContent = country.country;

    const x = document.createElement('button');
    x.className = 'chip-x';
    x.textContent = '×';
    x.setAttribute('aria-label', `Remove ${country.country}`);
    x.setAttribute('tabindex', '0');
    x.onclick = (e) => {
      e.stopPropagation();
      chip.classList.add('removing');
      setTimeout(() => removeCountry(country.c3), 120);
    };

    chip.appendChild(dot);
    chip.appendChild(text);
    chip.appendChild(x);
    container.appendChild(chip);
  });
}

// Screen reader announcements
function announceToScreenReader(message) {
  const announcer = document.getElementById('sr-announcer');
  if (announcer) {
    announcer.textContent = message;
    setTimeout(() => {
      announcer.textContent = '';
    }, 1000);
  }
}

function fmtPop(p) {
  if (p >= 1e9) return (p/1e9).toFixed(1) + 'B';
  if (p >= 1e6) return (p/1e6).toFixed(1) + 'M';
  if (p >= 1e3) return (p/1e3).toFixed(0) + 'K';
  return p.toString();
}
function fmtGdp(g) { return g >= 1000 ? '$' + (g/1000).toFixed(1) + 'K' : '$' + g.toFixed(0); }

function filtered() {
  return RAW_DATA.filter(d => {
    if (giniBase(d) == null || giniFinal(d) == null) return false;

    // If countries are selected, show ONLY those countries (overrides other filters)
    if (S.selectedCountries.size > 0) {
      return S.selectedCountries.has(d.c3);
    }

    // Otherwise apply region/income filters
    if (S.regionFilter !== 'all' && d.region_wb !== S.regionFilter) return false;
    if (S.incomeFilter !== 'all' && d.incomegroup !== S.incomeFilter) return false;
    if (S.hiddenRegions.has(d.region_wb)) return false;
    return true;
  });
}

// ===== INIT =====
const margin = { top: 28, right: 24, bottom: 58, left: 62 };
let W, H, svg, xSc, ySc, gQuad, gDots, gLabels;

function init() {
  populateDropdowns();
  buildLegend();
  stateFromURL();
  syncUIFromState();
  measure();
  buildChart();
  bindEvents();
  buildHeroStats();
  update();
  buildAnalysis();
}

function populateDropdowns() {
  const regs = [...new Set(RAW_DATA.map(d => d.region_wb))].sort();
  const incs = [...new Set(RAW_DATA.map(d => d.incomegroup))].filter(d => d !== 'Missing').sort();
  const rs = document.getElementById('regionFilter');
  regs.forEach(r => { const o = document.createElement('option'); o.value = r; o.textContent = REGION_SHORT[r]; rs.appendChild(o); });
  const is = document.getElementById('incomeFilter');
  incs.forEach(i => { const o = document.createElement('option'); o.value = i; o.textContent = i; is.appendChild(o); });

  // Mover filter dropdowns
  const mrs = document.getElementById('moverRegionFilter');
  regs.forEach(r => { const o = document.createElement('option'); o.value = r; o.textContent = REGION_SHORT[r]; mrs.appendChild(o); });
  const mis = document.getElementById('moverIncomeFilter');
  incs.forEach(i => { const o = document.createElement('option'); o.value = i; o.textContent = i; mis.appendChild(o); });
}

function buildLegend() {
  const c = document.getElementById('legendRow');
  Object.entries(REGION_COLORS).forEach(([r, col]) => {
    const el = document.createElement('div');
    el.className = 'lr-item';
    el.dataset.region = r;
    el.innerHTML = `<span class="lr-dot" style="background:${col}"></span>${REGION_SHORT[r]}`;
    el.addEventListener('click', () => {
      if (S.hiddenRegions.has(r)) { S.hiddenRegions.delete(r); el.classList.remove('dimmed'); }
      else { S.hiddenRegions.add(r); el.classList.add('dimmed'); }
      update(); buildAnalysis(); stateToURL();
    });
    c.appendChild(el);
  });
}

function measure() {
  const wrap = document.getElementById('chartWrap');
  const isFS = wrap.classList.contains('fullscreen');
  const ww = (isFS ? window.innerWidth - 40 : wrap.clientWidth - 48);
  W = ww - margin.left - margin.right;
  if (isFS) {
    H = window.innerHeight - 80 - margin.top - margin.bottom;
  } else {
    H = Math.min(680, Math.max(450, ww * 0.58)) - margin.top - margin.bottom;
  }
}

// ===== CHART =====
let currentTransform = d3.zoomIdentity;
let zoomBehavior;
let baseXDomain, baseYDomain;
let currentData = [];
let currentGetR = d => 4.5;

function buildChart() {
  const wrap = document.getElementById('chartWrap');
  wrap.querySelectorAll('svg').forEach(e => e.remove());

  svg = d3.select(wrap).append('svg')
    .attr('width', W + margin.left + margin.right)
    .attr('height', H + margin.top + margin.bottom);

  // Clip path for zoom
  svg.append('defs').append('clipPath').attr('id', 'chart-clip')
    .append('rect').attr('width', W).attr('height', H);

  const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

  xSc = d3.scaleLinear().range([0, W]);
  ySc = d3.scaleLinear().range([H, 0]);

  gQuad = g.append('g').attr('clip-path', 'url(#chart-clip)');
  g.append('g').attr('class', 'gx').attr('transform', `translate(0,${H})`);
  g.append('g').attr('class', 'gy');

  // Threshold lines inside clipped group
  gQuad.append('line').attr('class', 'thr-x');
  gQuad.append('line').attr('class', 'thr-y');

  // Quadrant labels inside clipped group
  ['ql-ll','ql-lh','ql-hl','ql-hh'].forEach(c => gQuad.append('text').attr('class', `q-label ${c}`));

  // X-axis label
  g.append('text').attr('class', 'ax-label xl')
    .attr('x', W/2).attr('y', H + 46).attr('text-anchor','middle');

  // Y-axis label
  g.append('text').attr('class', 'ax-label yl')
    .attr('transform','rotate(-90)').attr('x', -H/2).attr('y', -48).attr('text-anchor','middle');

  // Content groups inside clip
  const clipG = g.append('g').attr('clip-path', 'url(#chart-clip)');
  gLabels = clipG.append('g');
  gDots = clipG.append('g');

  // Zoom behavior
  zoomBehavior = d3.zoom()
    .scaleExtent([1, 12])
    .extent([[0, 0], [W, H]])
    .on('zoom', onZoom);

  svg.call(zoomBehavior);
}

function onZoom(event) {
  currentTransform = event.transform;
  render(false);
  const isZoomed = currentTransform.k !== 1 || currentTransform.x !== 0 || currentTransform.y !== 0;
  document.getElementById('resetZoomBtn').classList.toggle('hidden', !isZoomed);
  document.getElementById('zoomHint').style.opacity = isZoomed ? '0' : '1';
}

function resetZoom() {
  svg.transition().duration(500).call(zoomBehavior.transform, d3.zoomIdentity);
}

function update() {
  currentData = filtered();
  const T = S.threshold;

  // Compute base domains
  const xe = d3.extent(currentData, d => xVal(d));
  const ye = d3.extent(currentData, d => giniChange(d));
  const xp = (xe[1]-xe[0])*0.08||5, yp = (ye[1]-ye[0])*0.08||3;
  baseXDomain = [Math.min(xe[0]-xp, 15), Math.max(xe[1]+xp, 80)];
  baseYDomain = [Math.min(ye[0]-yp, -25), Math.max(ye[1]+yp, 20)];
  xSc.domain(baseXDomain);
  ySc.domain(baseYDomain);

  // Size scales
  const popE = d3.extent(currentData, d => d.population);
  const gdpE = d3.extent(currentData, d => d.gdp);
  const rPop = d3.scaleSqrt().domain([0,popE[1]]).range([3,30]);
  const rGdp = d3.scaleSqrt().domain([0,gdpE[1]]).range([3,20]);
  currentGetR = function(d) {
    if (S.sizeBy==='population') return rPop(d.population);
    if (S.sizeBy==='gdp') return rGdp(d.gdp);
    return 4.5;
  };

  // Reset zoom on data change
  currentTransform = d3.zoomIdentity;
  if (svg && zoomBehavior) svg.call(zoomBehavior.transform, d3.zoomIdentity);
  document.getElementById('resetZoomBtn').classList.add('hidden');
  document.getElementById('zoomHint').style.opacity = '1';

  render(true);

  // Count bar
  TOTAL_COUNT = RAW_DATA.filter(d => giniBase(d) != null && giniFinal(d) != null).length;
  document.getElementById('countBar').innerHTML = `Showing <strong>${currentData.length}</strong> of ${TOTAL_COUNT} countries`;

  updateTags();
  buildHeroStats();
  buildAnalysis();
}

function render(animate) {
  const data = currentData;
  const T = S.threshold;
  const dur = animate ? 400 : 0;

  // Zoomed scales
  const zx = currentTransform.rescaleX(xSc);
  const zy = currentTransform.rescaleY(ySc);
  const g = svg.select('g');

  // Axes
  const xa = d3.axisBottom(zx).ticks(8).tickSize(-H).tickPadding(8);
  const ya = d3.axisLeft(zy).ticks(8).tickSize(-W).tickPadding(8);

  if (dur) {
    g.select('.gx').transition().duration(dur).call(xa);
    g.select('.gy').transition().duration(dur).call(ya);
  } else {
    g.select('.gx').call(xa);
    g.select('.gy').call(ya);
  }

  // Axis labels
  g.select('.xl').text(`Lower inequality  \u2190  Gini index (${S.xAxis === 'base' ? S.baseYear : S.finalYear})  \u2192  Higher inequality`);
  g.select('.yl').text(`\u2190 Declined          Change in Gini, ${yearLabel()}          Rose \u2192`);

  // Quadrant fills
  const tx = zx(T), ty = zy(0);
  gQuad.selectAll('rect').remove();
  const qa = 0.45;
  const clamp = v => Math.max(0, v);
  gQuad.insert('rect',':first-child').attr('x',0).attr('y',clamp(ty)).attr('width',clamp(tx)).attr('height',clamp(H-ty)).attr('fill','#E6F2EC').attr('opacity',qa);
  gQuad.insert('rect',':first-child').attr('x',0).attr('y',0).attr('width',clamp(tx)).attr('height',clamp(ty)).attr('fill','#FFF6E0').attr('opacity',qa);
  gQuad.insert('rect',':first-child').attr('x',clamp(tx)).attr('y',clamp(ty)).attr('width',clamp(W-tx)).attr('height',clamp(H-ty)).attr('fill','#E8F0F8').attr('opacity',qa);
  gQuad.insert('rect',':first-child').attr('x',clamp(tx)).attr('y',0).attr('width',clamp(W-tx)).attr('height',clamp(ty)).attr('fill','#FCEAE8').attr('opacity',qa);

  // Threshold lines
  gQuad.select('.thr-x').attr('x1',tx).attr('x2',tx).attr('y1',0).attr('y2',H)
    .attr('stroke','#999').attr('stroke-dasharray','6,4').attr('stroke-width',1.2);
  gQuad.select('.thr-y').attr('x1',0).attr('x2',W).attr('y1',ty).attr('y2',ty)
    .attr('stroke','#999').attr('stroke-dasharray','6,4').attr('stroke-width',1.2);

  // Quadrant labels — anchored to quadrant corners
  const p = 8;
  const qlX1 = Math.max(p, tx - 160), qlX2 = Math.min(W - p, tx + 160);
  gQuad.select('.ql-ll').attr('x',p).attr('y',H-p).text('Lower & Declining \u2713').attr('fill','#2D7A50').attr('opacity',0.7);
  gQuad.select('.ql-lh').attr('x',p).attr('y',p+12).text('Lower & Rising \u26A0').attr('fill','#C47F17').attr('opacity',0.7);
  gQuad.select('.ql-hl').attr('x',W-p).attr('y',H-p).attr('text-anchor','end').text('Higher & Declining \u2198').attr('fill','#336B99').attr('opacity',0.7);
  gQuad.select('.ql-hh').attr('x',W-p).attr('y',p+12).attr('text-anchor','end').text('Higher & Rising \u2717').attr('fill','#C44536').attr('opacity',0.7);

  // === Dimming logic ===
  const hasRegionFilter = S.regionFilter !== 'all';
  const hasSearch = S.selectedCountries.size > 0;

  function dotOpacity(d) {
    if (hasSearch) return isSelected(d) ? 0.92 : 0.06;
    return 0.82;
  }

  // === DOTS ===
  const dots = gDots.selectAll('circle').data(data, d => d.c3);
  dots.exit().transition().duration(300).attr('r',0).remove();

  const enter = dots.enter().append('circle')
    .attr('cx', d => zx(xVal(d)))
    .attr('cy', d => zy(giniChange(d)))
    .attr('r', 0)
    .attr('fill', d => REGION_COLORS[d.region_wb]||'#999')
    .attr('stroke','#fff').attr('stroke-width',0.8)
    .attr('cursor','pointer')
    .on('mouseover', showTip)
    .on('mousemove', moveTip)
    .on('mouseout', hideTip);

  const merged = enter.merge(dots);
  const applyDots = dur ? merged.transition().duration(dur) : merged;
  applyDots
    .attr('cx', d => zx(xVal(d)))
    .attr('cy', d => zy(giniChange(d)))
    .attr('r', d => currentGetR(d))
    .attr('fill', d => REGION_COLORS[d.region_wb]||'#999')
    .attr('opacity', d => dotOpacity(d))
    .attr('stroke', d => isSelected(d) ? '#BA3A1E' : 'rgba(255,255,255,0.7)')
    .attr('stroke-width', d => isSelected(d) ? 2.5 : 0.8);

  // === SMART LABELS with collision detection ===
  // During zoom (animate=false), defer labels to avoid O(n²) on every frame
  if (!animate) {
    clearTimeout(render._labelTimer);
    render._labelTimer = setTimeout(() => renderLabels(data, zx, zy), 120);
    return;
  }
  renderLabels(data, zx, zy);
}

function renderLabels(data, zx, zy) {
  gLabels.selectAll('text').remove();
  if (!S.showLabels) return;

  const hasSearch = S.selectedCountries.size > 0;

  // Sort: search matches first, then by population (largest get label priority)
  const sorted = [...data].sort((a, b) => {
    const am = isSelected(a) ? 1 : 0, bm = isSelected(b) ? 1 : 0;
    if (bm !== am) return bm - am;
    return b.population - a.population;
  });

  const placed = []; // bounding boxes of placed labels
  const PAD_X = 2, PAD_Y = 1;
  const zoomK = currentTransform.k;
  const fontSize = Math.min(11, 9.5 * Math.min(zoomK, 1.4));
  const charW = fontSize < 10.5 ? 5.2 : 5.8;

  sorted.forEach(d => {
    const cx = zx(xVal(d)), cy = zy(giniChange(d));
    // Skip off-screen
    if (cx < -30 || cx > W + 30 || cy < -20 || cy > H + 20) return;

    const searched = isSelected(d);
    const text = searched ? d.country : d.c3;
    const r = currentGetR(d);
    const lx = cx + r + 4;
    const ly = cy + fontSize * 0.35;
    const lw = text.length * charW;
    const lh = fontSize + 2;

    const box = { x: lx - PAD_X, y: ly - lh + PAD_Y, w: lw + PAD_X*2, h: lh + PAD_Y*2 };

    if (!searched) {
      // Collision check
      const collides = placed.some(p =>
        box.x < p.x + p.w && box.x + box.w > p.x &&
        box.y < p.y + p.h && box.y + box.h > p.y
      );
      if (collides) return;
      if (lx + lw > W + 10 || lx < -5) return;
      if (ly < -5 || ly > H + 10) return;
    }

    placed.push(box);

    let opacity = 0.6;
    if (hasSearch && !searched) opacity = 0.05;
    if (hasSearch && searched) opacity = 1;

    gLabels.append('text')
      .attr('class', 'c-label')
      .attr('x', lx).attr('y', ly)
      .text(text)
      .attr('opacity', opacity)
      .attr('font-weight', searched ? '700' : '400')
      .attr('fill', searched ? '#BA3A1E' : 'var(--text-light)')
      .attr('font-size', fontSize + 'px');
  });
}


// ===== TOOLTIP =====
const QUAD_POLICY = {
  'low-decline': { label: 'Lower & Declining', color: '#2D7A50', note: 'Success story — inequality is low and falling' },
  'low-rise': { label: 'Lower & Rising', color: '#C47F17', note: 'Warning — gains may be reversing' },
  'high-decline': { label: 'Higher & Declining', color: '#336B99', note: 'Progress — but still far from equitable' },
  'high-rise': { label: 'Higher & Rising', color: '#C44536', note: 'Urgent — inequality is compounding' }
};

function getQuadrant(d) {
  const T = S.threshold;
  const high = xVal(d) >= T;
  const rising = giniChange(d) > 0;
  if (!high && !rising) return QUAD_POLICY['low-decline'];
  if (!high && rising) return QUAD_POLICY['low-rise'];
  if (high && !rising) return QUAD_POLICY['high-decline'];
  return QUAD_POLICY['high-rise'];
}

const tipEl = document.getElementById('tip');
function showTip(ev, d) {
  const dir = giniChange(d) > 0 ? '↑' : giniChange(d) < 0 ? '↓' : '→';
  const cc = giniChange(d) > 0 ? '#F2A899' : giniChange(d) < 0 ? '#7AD4A8' : '#AAA';
  const q = getQuadrant(d);
  tipEl.innerHTML = `
    <div class="tip-name">${d.country}</div>
    <div style="font-size:0.68rem;padding:3px 7px;margin-bottom:6px;border-radius:3px;background:${q.color};color:#fff;display:inline-block">${q.note}</div>
    <div class="tip-r"><span class="tip-l">Gini ${S.finalYear}</span><span class="tip-v">${giniFinal(d).toFixed(1)}</span></div>
    <div class="tip-r"><span class="tip-l">Gini ${S.baseYear}</span><span class="tip-v">${giniBase(d) != null ? giniBase(d).toFixed(1) : '—'}</span></div>
    <div class="tip-r"><span class="tip-l">Change</span><span class="tip-v" style="color:${cc}">${dir} ${Math.abs(giniChange(d)).toFixed(1)} pts</span></div>
    <div class="tip-r"><span class="tip-l">Population</span><span class="tip-v">${fmtPop(d.population)}</span></div>
    <div class="tip-r"><span class="tip-l">GDP/capita (PPP)</span><span class="tip-v">${fmtGdp(d.gdp)}</span></div>
    <div class="tip-r"><span class="tip-l">Region</span><span class="tip-v">${REGION_SHORT[d.region_wb]}</span></div>
    <div class="tip-r"><span class="tip-l">Income group</span><span class="tip-v">${d.incomegroup}</span></div>
    <span class="tip-badge ${d.interpolated==='No'?'obs':'ext'}">${d.interpolated==='No'?'● Observed data':'○ Extrapolated estimate'}</span>`;
  tipEl.style.opacity = '1';
}
function moveTip(ev) {
  let x = ev.clientX+14, y = ev.clientY-10;
  if (x + 300 > window.innerWidth) x = ev.clientX - 310;
  if (y + 240 > window.innerHeight) y = ev.clientY - 240;
  tipEl.style.left = x+'px'; tipEl.style.top = y+'px';
}
function hideTip() { tipEl.style.opacity = '0'; }

// ===== FILTER TAGS =====
function updateTags() {
  const c = document.getElementById('filterTags');
  c.innerHTML = '';
  const tags = [];
  if (S.regionFilter!=='all') tags.push({l:REGION_SHORT[S.regionFilter], cl:()=>{S.regionFilter='all';document.getElementById('regionFilter').value='all';}});
  if (S.incomeFilter!=='all') tags.push({l:S.incomeFilter, cl:()=>{S.incomeFilter='all';document.getElementById('incomeFilter').value='all';}});
  S.hiddenRegions.forEach(r => tags.push({l:`Hidden: ${REGION_SHORT[r]}`, cl:()=>{S.hiddenRegions.delete(r);document.querySelector(`.lr-item[data-region="${r}"]`).classList.remove('dimmed');}}));
  if (!tags.length) return;
  const lbl = document.createElement('span'); lbl.className='ftl'; lbl.textContent='Filters:'; c.appendChild(lbl);
  tags.forEach(t => {
    const el = document.createElement('span'); el.className='ftag';
    el.innerHTML = `${t.l} <span class="fx">×</span>`;
    el.querySelector('.fx').addEventListener('click', ()=>{t.cl(); update(); stateToURL();});
    c.appendChild(el);
  });
  if (tags.length>1) {
    const b = document.createElement('button'); b.className='clear-btn'; b.textContent='Clear all';
    b.addEventListener('click', ()=>{
      S.regionFilter='all'; S.incomeFilter='all'; S.hiddenRegions.clear();
      document.getElementById('regionFilter').value='all';
      document.getElementById('incomeFilter').value='all';
      document.querySelectorAll('.lr-item').forEach(e=>e.classList.remove('dimmed'));
      update(); stateToURL();
    });
    c.appendChild(b);
  }
}

// ===== HERO STATS =====
function buildHeroStats() {
  const data = RAW_DATA.filter(d => giniBase(d) != null && giniFinal(d) != null);
  const T = S.threshold;

  // Update headline and dek with current years
  document.getElementById('mainHeadline').innerHTML = `Most countries reduced inequality since ${S.baseYear} — but hundreds of millions are still being left&nbsp;behind`;
  document.getElementById('mainDek').textContent = `Since ${S.baseYear}, most countries have reduced income inequality. But the gains are unevenly distributed — in South Asia and Sub-Saharan Africa, home to nearly half the world's population, many countries remain deeply unequal, and some are moving in the wrong direction.`;

  const highRising = data.filter(d => xVal(d) >= T && giniChange(d) > 0);
  const hrPop = highRising.reduce((s,d) => s + d.population, 0);
  const declined = data.filter(d => giniChange(d) < 0);
  const totalPop = data.reduce((s,d) => s + d.population, 0);
  const avgGiniChange = data.reduce((s,d) => s + giniChange(d), 0) / data.length;

  document.getElementById('heroStats').innerHTML = `
    <div class="hero-card accent">
      <div class="hero-num">${fmtPop(hrPop)}</div>
      <div class="hero-label">people in "High & Rising" countries</div>
      <div class="hero-sub">${highRising.length} countries where inequality is already high and getting worse (${yearLabel()})</div>
    </div>
    <div class="hero-card">
      <div class="hero-num" style="color:#2D7A50">${(declined.length/data.length*100).toFixed(0)}%</div>
      <div class="hero-label">of countries saw inequality fall</div>
      <div class="hero-sub">${declined.length} of ${data.length} countries improved since ${S.baseYear}</div>
    </div>
    <div class="hero-card">
      <div class="hero-num" style="color:${avgGiniChange < 0 ? '#2D7A50' : '#C44536'}">${avgGiniChange > 0 ? '+' : ''}${avgGiniChange.toFixed(1)}</div>
      <div class="hero-label">avg. Gini change globally</div>
      <div class="hero-sub">A ${avgGiniChange < 0 ? 'net improvement' : 'net worsening'} — but enormous variation across countries</div>
    </div>
  `;
}

// ===== BELOW-CHART ANALYSIS =====
function buildAnalysis() {
  const data = filtered();
  const T = S.threshold;
  const allRegions = Object.keys(REGION_COLORS);

  // === Quadrant cards ===
  const quads = QUADRANT_DEFS.map(q => {
    const countries = data.filter(d => {
      const xm = q.xSide==='low' ? xVal(d)<T : xVal(d)>=T;
      const ym = q.ySide==='low' ? giniChange(d)<0 : giniChange(d)>=0;
      return xm && ym;
    });
    const pop = countries.reduce((s,d)=>s+d.population, 0);
    const rb = allRegions.map(r => {
      const rc = countries.filter(d=>d.region_wb===r);
      return {region:r, count:rc.length, pct: countries.length ? (rc.length/countries.length*100) : 0};
    }).filter(r=>r.count>0).sort((a,b)=>b.count-a.count);
    return {...q, countries, count:countries.length, pop, rb};
  });
  const totalPop = quads.reduce((s,q)=>s+q.pop, 0);

  document.getElementById('quadCards').innerHTML = quads.map(q => `
    <div class="q-card" style="background:${q.bg};border-color:${q.color};">
      <h3 style="color:${q.color}">${q.label}</h3>
      <div class="q-sub">${q.sub}</div>
      <div class="q-stat-row">
        <span class="q-big" style="color:${q.color}">${q.count}</span>
        <span class="q-stat-label">countries</span>
      </div>
      <div class="q-stat-row">
        <span class="q-big" style="color:${q.color}">${totalPop>0?((q.pop/totalPop)*100).toFixed(0):'0'}%</span>
        <span class="q-stat-label">of population shown</span>
      </div>
      <div class="q-regions">
        ${q.rb.slice(0,5).map(r => `
          <div class="q-reg-row">
            <span class="q-reg-dot" style="background:${REGION_COLORS[r.region]}"></span>
            ${REGION_SHORT[r.region]}
            <span class="q-reg-n">${r.count} (${r.pct.toFixed(0)}%)</span>
          </div>
        `).join('')}
      </div>
    </div>
  `).join('');

  // === Key takeaways ===
  const declined = data.filter(d => giniChange(d) < 0);
  const rose = data.filter(d => giniChange(d) > 0);
  const highAndRising = quads[3];
  const popDeclined = declined.reduce((s,d)=>s+d.population,0);
  const popTotal = data.reduce((s,d)=>s+d.population,0);
  const avgChange = data.reduce((s,d)=>s+giniChange(d),0) / data.length;
  const ssaData = data.filter(d=>d.region_wb==='Sub-Saharan Africa');
  const ssaAvgGini = ssaData.length ? (ssaData.reduce((s,d)=>s+giniFinal(d),0)/ssaData.length) : 0;
  const ecaData = data.filter(d=>d.region_wb==='Europe and Central Asia');
  const ecaRose = ecaData.filter(d=>giniChange(d)>0);

  const findings = [
    { text: `<strong>${declined.length} of ${data.length} countries</strong> (${(declined.length/data.length*100).toFixed(0)}%) saw income inequality <strong>decline</strong> between ${S.baseYear} and ${S.finalYear} \u2014 representing <strong>${fmtPop(popDeclined)}</strong> people, or ${(popDeclined/popTotal*100).toFixed(0)}% of the population shown.` },
    { text: `The average change in Gini across all countries was <strong>${avgChange.toFixed(1)} points</strong> \u2014 a ${avgChange<0?'net improvement':'net worsening'} globally. But averages mask huge variation: changes ranged from ${data.reduce((m,d)=>Math.min(m,giniChange(d)),0).toFixed(1)} to +${data.reduce((m,d)=>Math.max(m,giniChange(d)),0).toFixed(1)} points.` },
    { text: `<strong>Sub-Saharan Africa</strong> has the highest average Gini (${ssaAvgGini.toFixed(1)} in ${S.finalYear}) and dominates the \u201CHigher\u201D quadrants \u2014 ${ssaData.filter(d=>xVal(d)>=T).length} of its ${ssaData.length} countries have a Gini above ${T}.` },
    { text: `<strong>Europe & Central Asia</strong> tells a more complex story: while it has the lowest average inequality, <strong>${ecaRose.length} of ${ecaData.length}</strong> countries saw Gini <em>rise</em> \u2014 many former Soviet states transitioning to market economies.` },
    { text: `The <strong>\u201CHigher & Rising\u201D</strong> quadrant \u2014 the most concerning \u2014 contains <strong>${highAndRising.count} countries</strong> with ${(highAndRising.pop/totalPop*100).toFixed(0)}% of the shown population. These are places where already-high inequality is getting worse.` },
  ];

  document.getElementById('tkList').innerHTML = findings.map((f,i) => `
    <div class="tk-item">
      <span class="tk-num">${i+1}</span>
      <span class="tk-text">${f.text}</span>
    </div>
  `).join('');

  // === Country spotlight: top 12 by population ===
  const spotData = [...data].sort((a,b) => b.population - a.population).slice(0, 12);
  const maxGini = 75; // scale bar against this max

  document.getElementById('spotlightSub').textContent = `How the world's most populous countries changed, ${yearLabel()}. Bars show Gini level; arrow shows direction of change.`;
  document.getElementById('spotlightGrid').innerHTML = spotData.map(d => {
    const wBase = (giniBase(d) / maxGini * 100).toFixed(1);
    const wFinal = (giniFinal(d) / maxGini * 100).toFixed(1);
    const chg = giniChange(d);
    const dir = chg > 0 ? '\u2191' : chg < 0 ? '\u2193' : '\u2192';
    const cls = chg < 0 ? 'down' : chg > 0 ? 'up' : '';
    const barColor = REGION_COLORS[d.region_wb] || '#999';
    return `
      <div class="spot-row">
        <div>
          <div class="spot-name">${d.country}</div>
          <div class="spot-pop">${fmtPop(d.population)}</div>
        </div>
        <div class="spot-bar-wrap">
          <div class="spot-bar-1990" style="width:${wBase}%"></div>
          <div class="spot-bar-2022" style="width:${wFinal}%;background:${barColor};opacity:0.5"></div>
          <div class="spot-bar-label">${giniFinal(d).toFixed(1)}</div>
        </div>
        <div class="spot-change ${cls}">${dir} ${Math.abs(chg).toFixed(1)}</div>
      </div>`;
  }).join('');

  // === Biggest movers ===
  buildMovers();

  // === Regional snapshot (sorted by severity - highest avg Gini first) ===
  const regStats = allRegions.map(r => {
    const rd = data.filter(d => d.region_wb === r);
    if (!rd.length) return null;
    const avgFinal = rd.reduce((s,d)=>s+giniFinal(d),0)/rd.length;
    const avgChg = rd.reduce((s,d)=>s+giniChange(d),0)/rd.length;
    const pctDeclined = (rd.filter(d=>giniChange(d)<0).length / rd.length * 100);
    const pop = rd.reduce((s,d)=>s+d.population,0);
    return { region: r, n: rd.length, avgFinal, avgChg, pctDeclined, pop };
  }).filter(Boolean).sort((a,b) => b.avgFinal - a.avgFinal);

  document.getElementById('regCards').innerHTML = regStats.map((r, i) => `
    <div class="reg-card" style="border-top-color:${REGION_COLORS[r.region]}">
      <div class="rc-name" style="color:${REGION_COLORS[r.region]}">${REGION_SHORT[r.region]}</div>
      <div class="rc-stat"><span>${r.n}</span> countries \u00B7 <span>${fmtPop(r.pop)}</span> people</div>
      <div class="rc-stat">Avg. Gini ${S.finalYear}: <span>${r.avgFinal.toFixed(1)}</span></div>
      <div class="rc-stat">Avg. change: <span style="color:${r.avgChg<0?'#2D7A50':'#C44536'}">${r.avgChg>0?'+':''}${r.avgChg.toFixed(1)}</span> pts</div>
      <div class="rc-stat"><span>${r.pctDeclined.toFixed(0)}%</span> of countries declined</div>
    </div>
  `).join('');

  // === Counterfactual ===
  const hrCountries = quads[3].countries; // Higher & Rising
  const hrTotalPop = hrCountries.reduce((s,d)=>s+d.population, 0);
  const avgHRGini = hrCountries.length ? hrCountries.reduce((s,d)=>s+giniFinal(d),0)/hrCountries.length : 0;
  // What if they each reduced by 5 Gini points (approx Brazil's achievement)?
  const targetReduction = 5;

  document.getElementById('counterfactual').innerHTML = `
    <h3>What would it take?</h3>
    <p>If every country in the <strong>"Higher & Rising"</strong> quadrant reduced its Gini by just <strong>${targetReduction} points</strong> \u2014 roughly what Brazil achieved between ${S.baseYear} and ${S.finalYear} \u2014</p>
    <span class="cf-big">${fmtPop(hrTotalPop)} people</span>
    <p>across <strong>${hrCountries.length} countries</strong> would see meaningful improvement. Their average Gini would fall from <strong>${avgHRGini.toFixed(1)}</strong> to <strong>${(avgHRGini - targetReduction).toFixed(1)}</strong> \u2014 still high, but moving in the right direction.</p>
  `;
}

// ===== MOVERS (with own filters) =====
let moverState = { region: 'all', income: 'all' };

function buildMovers() {
  const data = filtered();
  let moverData = data;
  if (moverState.region !== 'all') moverData = moverData.filter(d => d.region_wb === moverState.region);
  if (moverState.income !== 'all') moverData = moverData.filter(d => d.incomegroup === moverState.income);

  if (moverData.length === 0) {
    document.getElementById('moversGrid').innerHTML = '<p style="color:var(--text-faint);font-size:0.85rem;">No countries match the selected filters.</p>';
    return;
  }

  const sorted = [...moverData].sort((a,b) => giniChange(a) - giniChange(b));
  const n = Math.min(8, Math.ceil(sorted.length / 2));
  const topDecliners = sorted.slice(0, n);
  const topRisers = sorted.slice(-n).reverse();

  function renderTable(list, direction) {
    const isDown = direction === 'down';
    return `
      <div class="mover-block">
        <h4 style="color:${isDown ? '#2D7A50' : '#C44536'}">${isDown ? '\u2193 Biggest declines (more equal)' : '\u2191 Biggest rises (less equal)'}</h4>
        <table class="mover-table">
          <tr><th>Country</th><th>${S.baseYear}</th><th>${S.finalYear}</th><th>Change</th></tr>
          ${list.map(d => `<tr>
            <td>${d.country}</td>
            <td>${giniBase(d).toFixed(1)}</td>
            <td>${giniFinal(d).toFixed(1)}</td>
            <td class="${isDown?'chg-down':'chg-up'}">${isDown?'':'+'}${giniChange(d).toFixed(1)}</td>
          </tr>`).join('')}
        </table>
      </div>`;
  }

  document.getElementById('moversTitle').textContent = `Biggest movers, ${yearLabel()}`;
  document.getElementById('moversGrid').innerHTML = renderTable(topDecliners, 'down') + renderTable(topRisers, 'up');
}


// ===== CHART DOWNLOAD =====
function downloadChart(exportFilename) {
  const fileName = (exportFilename || `inequality-${S.baseYear}-${S.finalYear}`)
    .replace(/[<>:"/\\|?*]/g, '_') + '.png';
 
  const btn = document.getElementById('downloadBtn');
  if (btn.disabled) return;
  btn.disabled = true;
  const origText = btn.textContent;
  btn.textContent = '\u23F3 Exporting\u2026';

 
  const data = currentData;
  if (!data || !data.length) {
    btn.disabled = false; btn.textContent = origText;
    return;
  }

  const DPR = 2;
  const EW = 1600, EH = 1140;
  const T = S.threshold;
  const yearStr = yearLabel();
  const xLabel = S.xAxis === 'base' ? S.baseYear : S.finalYear;
  const hasSearch = S.selectedCountries.size > 0;

  // Layout
  const padX = 80, padR = 50, titleH = 95;
  const chartT = titleH + 5;
  const chartW = EW - padX - padR;
  const legendH = S.sizeBy !== 'none' ? 100 : 60;
  const sourceH = 34;
  const chartH = EH - chartT - legendH - sourceH - 16;
  const chartB = chartT + chartH;

  // Scales
  const xe = d3.extent(data, d => xVal(d));
  const ye = d3.extent(data, d => giniChange(d));
  const xp = (xe[1] - xe[0]) * 0.08 || 5;
  const yp = (ye[1] - ye[0]) * 0.08 || 3;
  const exSc = d3.scaleLinear().domain([Math.min(xe[0]-xp, 15), Math.max(xe[1]+xp, 80)]).range([0, chartW]);
  const eySc = d3.scaleLinear().domain([Math.min(ye[0]-yp, -25), Math.max(ye[1]+yp, 20)]).range([chartH, 0]);
  const popE = d3.extent(data, d => d.population);
  const gdpE = d3.extent(data, d => d.gdp);
  const erPop = d3.scaleSqrt().domain([0, popE[1]]).range([3, 28]);
  const erGdp = d3.scaleSqrt().domain([0, gdpE[1]]).range([3, 18]);
  function eR(d) {
    if (S.sizeBy === 'population') return erPop(d.population);
    if (S.sizeBy === 'gdp') return erGdp(d.gdp);
    return 4.5;
  }

  // Subtitle from active filters
  const filters = [];
  if (S.regionFilter !== 'all') filters.push(REGION_SHORT[S.regionFilter] || S.regionFilter);
  if (S.incomeFilter !== 'all') filters.push(S.incomeFilter);
  if (S.hiddenRegions.size > 0) filters.push(S.hiddenRegions.size + ' regions hidden');
  if (hasSearch) {
    if (S.selectedCountries.size <= 5) {
      const names = [...S.selectedCountries]
        .map(c3 => RAW_DATA.find(d => d.c3 === c3)?.country)
        .filter(Boolean)
        .join(', ');
      filters.push('Selected: ' + names);
    } else {
      filters.push(S.selectedCountries.size + ' countries selected');
    }
  }

 
  const s = [];
  s.push(`<svg xmlns="http://www.w3.org/2000/svg" width="${EW}" height="${EH}" viewBox="0 0 ${EW} ${EH}">`);
  s.push(`<rect width="${EW}" height="${EH}" fill="#FAFAF7"/>`);

  // Title block
  s.push(`<text x="${padX}" y="38" font-family="Georgia,serif" font-size="24" font-weight="700" fill="#222220">${escXml('Income Inequality: Level & Change, ' + yearStr)}</text>`);
  let metaY = 62;
  if (filters.length) {
    s.push(`<text x="${padX}" y="${metaY}" font-family="sans-serif" font-size="13" fill="#888882">${escXml(filters.join(' \u00B7 '))}</text>`);
    metaY = 80;
  }
  s.push(`<text x="${padX}" y="${metaY}" font-family="sans-serif" font-size="12" fill="#ABAAA2">${escXml(data.length + ' countries \u00B7 Bubble = ' + (S.sizeBy === 'none' ? 'uniform' : S.sizeBy) + ' \u00B7 Threshold: Gini ' + T)}</text>`);

  // Chart group
  s.push(`<g transform="translate(${padX},${chartT})">`);

  // Quadrant fills — clamp tx/ty to chart bounds
  const tx = Math.max(0, Math.min(chartW, exSc(T)));
  const ty = Math.max(0, Math.min(chartH, eySc(0)));
  [
    { x:0, y:ty, w:tx, h:chartH-ty, fill:'#E6F2EC' },
    { x:0, y:0, w:tx, h:ty, fill:'#FFF6E0' },
    { x:tx, y:ty, w:chartW-tx, h:chartH-ty, fill:'#E8F0F8' },
    { x:tx, y:0, w:chartW-tx, h:ty, fill:'#FCEAE8' }
  ].forEach(q => {
    if (q.w > 0 && q.h > 0) s.push(`<rect x="${q.x}" y="${q.y}" width="${q.w}" height="${q.h}" fill="${q.fill}" opacity="0.5"/>`);
  });

  // Threshold lines
  s.push(`<line x1="${tx}" x2="${tx}" y1="0" y2="${chartH}" stroke="#999" stroke-dasharray="6,4" stroke-width="1.2"/>`);
  s.push(`<line x1="0" x2="${chartW}" y1="${ty}" y2="${ty}" stroke="#999" stroke-dasharray="6,4" stroke-width="1.2"/>`);

  // Quadrant labels
  const qlPad = 8, qlFs = 11;
  [
    { t:'Lower &amp; Declining', x:qlPad, y:chartH-qlPad, c:'#2D7A50', a:'start' },
    { t:'Lower &amp; Rising', x:qlPad, y:qlPad+qlFs, c:'#C47F17', a:'start' },
    { t:'Higher &amp; Declining', x:chartW-qlPad, y:chartH-qlPad, c:'#336B99', a:'end' },
    { t:'Higher &amp; Rising', x:chartW-qlPad, y:qlPad+qlFs, c:'#C44536', a:'end' }
  ].forEach(q => {
    s.push(`<text x="${q.x}" y="${q.y}" font-family="sans-serif" font-size="${qlFs}" font-weight="600" fill="${q.c}" text-anchor="${q.a}" opacity="0.7">${q.t}</text>`);
  });

  // Grid + tick labels
  exSc.ticks(8).forEach(v => {
    const x = exSc(v);
    s.push(`<line x1="${x}" x2="${x}" y1="0" y2="${chartH}" stroke="#E8E6DF" stroke-dasharray="2,3"/>`);
    s.push(`<text x="${x}" y="${chartH+18}" font-family="sans-serif" font-size="11" fill="#888882" text-anchor="middle">${v}</text>`);
  });
  eySc.ticks(8).forEach(v => {
    const y = eySc(v);
    s.push(`<line x1="0" x2="${chartW}" y1="${y}" y2="${y}" stroke="#E8E6DF" stroke-dasharray="2,3"/>`);
    s.push(`<text x="-14" y="${y+4}" font-family="sans-serif" font-size="11" fill="#888882" text-anchor="end">${v}</text>`);
  });

  // Axis labels
  s.push(`<text x="${chartW/2}" y="${chartH+42}" font-family="sans-serif" font-size="13" font-weight="500" fill="#555550" text-anchor="middle">\u2190 Lower inequality    Gini index (${escXml(xLabel)})    Higher inequality \u2192</text>`);
  s.push(`<g transform="translate(-54,${chartH/2}) rotate(-90)"><text font-family="sans-serif" font-size="13" font-weight="500" fill="#555550" text-anchor="middle">\u2190 Declined    Change in Gini, ${escXml(yearStr)}    Rose \u2192</text></g>`);

  // Dots — large behind small
  const sortedDots = [...data].sort((a,b) => eR(b) - eR(a));
  sortedDots.forEach(d => {
    const cx = exSc(xVal(d)), cy = eySc(giniChange(d)), r = eR(d);
    const matched = hasSearch && isSelected(d);
    const dimmed = hasSearch && !matched;
    const opacity = dimmed ? 0.08 : (matched ? 0.9 : 0.75);
    const strokeCol = matched ? '#BA3A1E' : '#fff';
    const strokeW = matched ? 2.5 : 1.2;  // Increased from 2/0.8 to 2.5/1.2
    const strokeOp = matched ? 1 : 0.7;
    s.push(`<circle cx="${cx}" cy="${cy}" r="${r}" fill="${REGION_COLORS[d.region_wb]||'#999'}" opacity="${opacity}" stroke="${strokeCol}" stroke-width="${strokeW}" stroke-opacity="${strokeOp}"/>`);
  });

  // Smart labels — search matches get priority + full country names
  // Try right side first, then left side for dots near right edge
  const labelSorted = [...data].sort((a,b) => {
    const am = hasSearch && isSelected(a) ? 1 : 0;
    const bm = hasSearch && isSelected(b) ? 1 : 0;
    if (bm !== am) return bm - am;
    return b.population - a.population;
  });
  const placed = [];
  const maxLabels = Math.min(50, data.length);
  let labelCount = 0;
  labelSorted.forEach(d => {
    if (labelCount >= maxLabels) return;
    const cx = exSc(xVal(d)), cy = eySc(giniChange(d));
    if (cx < -20 || cx > chartW + 20 || cy < -10 || cy > chartH + 10) return;
    const matched = hasSearch && isSelected(d);
    const dimmed = hasSearch && !matched;
    const text = matched ? d.country : d.c3;
    const r = eR(d);
    const charW = matched ? 6.5 : 5.5;
    const lw = text.length * charW, lh = 12;

    // Try right side, then left side
    let lx = cx + r + 3, ly = cy + 3.5;
    let box = { x:lx-1, y:ly-lh, w:lw+2, h:lh+2 };
    let ok = (lx + lw <= chartW + 10) && (lx >= -5);

    if (!ok || (!matched && placed.some(p => box.x < p.x+p.w && box.x+box.w > p.x && box.y < p.y+p.h && box.y+box.h > p.y))) {
      // Try left side
      lx = cx - r - lw - 3;
      box = { x:lx-1, y:ly-lh, w:lw+2, h:lh+2 };
      ok = (lx >= -5) && (lx + lw <= chartW + 10);
    }

    if (!matched) {
      if (!ok) return;
      const collides = placed.some(p => box.x < p.x+p.w && box.x+box.w > p.x && box.y < p.y+p.h && box.y+box.h > p.y);
      if (collides) return;
    }
    placed.push(box);
    const fill = matched ? '#BA3A1E' : '#333333';  // Darkened from #888882 to #333333
    const fw = matched ? '700' : '400';
    const fs = matched ? '14' : '12';  // Increased from 11/9.5 to 14/12
    const op = dimmed ? 0.15 : (matched ? 1.0 : 0.85);  // Increased from 0.08/0.7 to 0.15/0.85
    s.push(`<text x="${lx}" y="${ly}" font-family="sans-serif" font-size="${fs}" font-weight="${fw}" fill="${fill}" opacity="${op}">${escXml(text)}</text>`);
    labelCount++;
  });

  s.push('</g>'); // end chart group

  // Region Legend
  const legY = chartB + 64;
  let legX = padX;
  s.push(`<text x="${legX}" y="${legY}" font-family="sans-serif" font-size="11" font-weight="600" fill="#555550">Regions:</text>`);
  legX += 62;
  const activeRegions = Object.keys(REGION_COLORS).filter(r => !S.hiddenRegions.has(r));
  activeRegions.forEach(r => {
    if (legX > EW - 120) return; // overflow guard
    s.push(`<circle cx="${legX}" cy="${legY-3.5}" r="5" fill="${REGION_COLORS[r]}"/>`);
    s.push(`<text x="${legX+9}" y="${legY}" font-family="sans-serif" font-size="10.5" fill="#555550">${escXml(REGION_SHORT[r])}</text>`);
    legX += REGION_SHORT[r].length * 6.5 + 24;
  });

  // Bubble Size Legend
  if (S.sizeBy !== 'none') {
    const sizeLegY = legY + 32;
    let slx = padX;
    s.push(`<text x="${slx}" y="${sizeLegY+4}" font-family="sans-serif" font-size="11" font-weight="600" fill="#555550">${S.sizeBy === 'population' ? 'Population' : 'GDP/cap'}:</text>`);
    slx += 88;
    const refVals = S.sizeBy === 'population' ? [10e6, 100e6, 500e6, 1.4e9] : [5000, 20000, 50000, 130000];
    const refLabels = S.sizeBy === 'population' ? ['10M','100M','500M','1.4B'] : ['$5k','$20k','$50k','$130k'];
    const rScale = S.sizeBy === 'population' ? erPop : erGdp;
    refVals.forEach((v, i) => {
      const r = Math.min(rScale(v), 26); // cap radius
      s.push(`<circle cx="${slx}" cy="${sizeLegY}" r="${r}" fill="none" stroke="#999" stroke-width="0.8"/>`);
      s.push(`<text x="${slx}" y="${sizeLegY+r+12}" font-family="sans-serif" font-size="9" fill="#888882" text-anchor="middle">${refLabels[i]}</text>`);
      slx += Math.max(r * 2 + 16, 55);
    });
  }

  // Source
  s.push(`<text x="${padX}" y="${EH-12}" font-family="sans-serif" font-size="9.5" fill="#ABAAA2">${escXml('Source: UNU-WIDER, World Income Inequality Database (WIID) Companion dataset. Version 28 April 2025. https://doi.org/10.35188/UNU-WIDER/WIIDcomp-280425')}</text>`);

  s.push('</svg>');
  const svgStr = s.join('\n');

  // --- Render to canvas at 2x DPI ---
  const canvas = document.createElement('canvas');
  canvas.width = EW * DPR;
  canvas.height = EH * DPR;
  const ctx = canvas.getContext('2d');
  ctx.scale(DPR, DPR);

  function resetBtn(success) {
    if (success) {
      btn.textContent = '\u2713 Downloaded';
      btn.classList.add('done');
      setTimeout(() => { btn.disabled = false; btn.textContent = origText; btn.classList.remove('done'); }, 1800);
    } else {
      btn.disabled = false; btn.textContent = origText;
    }
  }

  // Safety timeout — if image never loads, unlock button after 8s
  const safetyTimer = setTimeout(() => { resetBtn(false); console.warn('Export: timed out'); }, 8000);

  const img = new Image();
  img.onerror = () => { clearTimeout(safetyTimer); resetBtn(false); console.error('Export: SVG render failed'); };
  img.onload = () => {
    clearTimeout(safetyTimer);
    ctx.fillStyle = '#FAFAF7';
    ctx.fillRect(0, 0, EW, EH);
    ctx.drawImage(img, 0, 0, EW, EH);

    canvas.toBlob(async pngBlob => {
      if (!pngBlob) { resetBtn(false); console.error('Export: PNG encode failed'); return; }

      // Tier 1: Native "Save As" dialog (Chrome/Edge — gives full folder selection)
      if (window.showSaveFilePicker) {
        try {
          const handle = await showSaveFilePicker({
            suggestedName: fileName,
            types: [{ description: 'PNG Image', accept: { 'image/png': ['.png'] } }]
          });
          const writable = await handle.createWritable();
          await writable.write(pngBlob);
          await writable.close();
          resetBtn(true);
          return;
        } catch (e) {
          // User cancelled the dialog — not an error
          if (e.name === 'AbortError') { resetBtn(false); return; }
          // API failed — fall through to Tier 2
        }
      }

      // Tier 2: <a download> (downloads to default folder)
      try {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(pngBlob);
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(a.href), 2000);
        resetBtn(true);
      } catch(e) {
        // Tier 3: Inline overlay for sandboxed environments
        const dataUrl = canvas.toDataURL('image/png');
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;cursor:pointer';
        overlay.innerHTML = '<p style="color:#fff;font-family:sans-serif;font-size:14px">Right-click the image to save</p>'
          + '<img src="' + dataUrl + '" style="max-width:92%;max-height:82%;border-radius:6px;box-shadow:0 4px 24px rgba(0,0,0,0.5)">';
        overlay.addEventListener('click', () => overlay.remove());
        document.body.appendChild(overlay);
        resetBtn(true);
      }
    }, 'image/png');
  };
  img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgStr);
}

function escXml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ===== FULLSCREEN =====
function toggleFullscreen() {
  const wrap = document.getElementById('chartWrap');
  const overlay = document.getElementById('fsOverlay');
  const btn = document.getElementById('expandBtn');
  const isFS = wrap.classList.contains('fullscreen');

  if (isFS) {
    wrap.classList.remove('fullscreen');
    overlay.classList.remove('active');
    btn.innerHTML = '⛶ Expand';
    document.body.style.overflow = '';
  } else {
    wrap.classList.add('fullscreen');
    overlay.classList.add('active');
    btn.innerHTML = '✕ Close';
    document.body.style.overflow = 'hidden';
  }

  // Rebuild chart at new size
  measure();
  buildChart();
  update();
}

// ===== EVENTS =====
function bindEvents() {
  document.getElementById('regionFilter').addEventListener('change', e => { S.regionFilter=e.target.value; update(); stateToURL(); });
  document.getElementById('incomeFilter').addEventListener('change', e => { S.incomeFilter=e.target.value; update(); stateToURL(); });

  // Year selectors with enforcement: finalYear must be > baseYear
  document.getElementById('baseYearSelect').addEventListener('change', e => {
    S.baseYear = e.target.value;
    // Enforce: final must be after base
    if (YEAR_ORDER.indexOf(S.finalYear) <= YEAR_ORDER.indexOf(S.baseYear)) {
      const bi = YEAR_ORDER.indexOf(S.baseYear);
      S.finalYear = YEAR_ORDER[Math.min(bi + 1, YEAR_ORDER.length - 1)];
      document.getElementById('finalYearSelect').value = S.finalYear;
    }
    updateFinalYearOptions();
    update(); stateToURL();
  });
  document.getElementById('finalYearSelect').addEventListener('change', e => {
    S.finalYear = e.target.value;
    // Enforce: base must be before final
    if (YEAR_ORDER.indexOf(S.finalYear) <= YEAR_ORDER.indexOf(S.baseYear)) {
      const fi = YEAR_ORDER.indexOf(S.finalYear);
      S.baseYear = YEAR_ORDER[Math.max(fi - 1, 0)];
      document.getElementById('baseYearSelect').value = S.baseYear;
    }
    updateBaseYearOptions();
    update(); stateToURL();
  });
  document.getElementById('xAxisSelect').addEventListener('change', e => { S.xAxis=e.target.value; update(); stateToURL(); });
  document.getElementById('thresholdInput').addEventListener('change', e => { S.threshold=Math.min(80, Math.max(20, parseFloat(e.target.value)||40)); e.target.value=S.threshold; update(); stateToURL(); });
  document.getElementById('sizeBySelect').addEventListener('change', e => { S.sizeBy=e.target.value; update(); stateToURL(); });
  document.getElementById('labelToggle').addEventListener('change', e => { S.showLabels=e.target.checked; render(false); stateToURL(); });

  // Autocomplete country search
  let searchDebounce;
  let keyboardIndex = -1;
  const searchInput = document.getElementById('countrySearch');
  const autocompleteList = document.getElementById('autocomplete-list');

  function closeDropdown() {
    autocompleteList.classList.add('hidden');
    searchInput.setAttribute('aria-expanded', 'false');
    searchInput.removeAttribute('aria-activedescendant');
    autocompleteList.innerHTML = '';
    keyboardIndex = -1;
  }

  function openDropdown(results) {
    // Clear previous results
    autocompleteList.innerHTML = '';

    if (results.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'autocomplete-empty';
      empty.textContent = 'No matches found';
      autocompleteList.appendChild(empty);
    } else {
      results.forEach(d => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.dataset.c3 = d.c3;
        item.id = `option-${d.c3}`;
        item.setAttribute('role', 'option');
        item.setAttribute('aria-selected', 'false');

        const dot = document.createElement('span');
        dot.className = 'autocomplete-dot';
        dot.style.background = REGION_COLORS[d.region_wb] || '#999';

        const name = document.createElement('span');
        name.className = 'autocomplete-name';
        name.textContent = d.country;

        const c3 = document.createElement('span');
        c3.className = 'autocomplete-c3';
        c3.textContent = d.c3;

        const region = document.createElement('span');
        region.className = 'autocomplete-region';
        region.textContent = d.region_wb;

        item.appendChild(dot);
        item.appendChild(name);
        item.appendChild(c3);
        item.appendChild(region);

        // Add click handler
        item.addEventListener('click', () => {
          addCountry(d.c3);
          searchInput.value = '';
          S.searchTerm = '';
          closeDropdown();
        });

        autocompleteList.appendChild(item);
      });
    }
    autocompleteList.classList.remove('hidden');
    searchInput.setAttribute('aria-expanded', 'true');
    keyboardIndex = -1;
  }

  // Search input handler
  searchInput.addEventListener('input', e => {
    S.searchTerm = e.target.value.trim();
    clearTimeout(searchDebounce);

    if (S.searchTerm.length < 2) {
      closeDropdown();
      return;
    }

    searchDebounce = setTimeout(() => {
      const results = searchCountries(S.searchTerm);
      openDropdown(results);
    }, 200);
  });

  // Keyboard navigation
  searchInput.addEventListener('keydown', e => {
    const items = autocompleteList.querySelectorAll('.autocomplete-item');

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (items.length === 0) return;

      items.forEach(item => item.classList.remove('keyboard-focus'));
      keyboardIndex = (keyboardIndex + 1) % items.length;
      items[keyboardIndex].classList.add('keyboard-focus');
      items[keyboardIndex].scrollIntoView({ block: 'nearest' });
      searchInput.setAttribute('aria-activedescendant', items[keyboardIndex].id);
    }
    else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (items.length === 0) return;

      items.forEach(item => item.classList.remove('keyboard-focus'));
      keyboardIndex = keyboardIndex <= 0 ? items.length - 1 : keyboardIndex - 1;
      items[keyboardIndex].classList.add('keyboard-focus');
      items[keyboardIndex].scrollIntoView({ block: 'nearest' });
      searchInput.setAttribute('aria-activedescendant', items[keyboardIndex].id);
    }
    else if (e.key === 'Enter') {
      e.preventDefault();
      if (keyboardIndex >= 0 && items[keyboardIndex]) {
        addCountry(items[keyboardIndex].dataset.c3);
        searchInput.value = '';
        S.searchTerm = '';
        closeDropdown();
      }
    }
    else if (e.key === 'Escape') {
      e.preventDefault();
      closeDropdown();
    }
  });

  // Click outside to close
  document.addEventListener('click', e => {
    if (!searchInput.contains(e.target) && !autocompleteList.contains(e.target)) {
      closeDropdown();
    }
  });

  // Zoom buttons
  document.getElementById('resetZoomBtn').addEventListener('click', resetZoom);
  document.getElementById('zoomInBtn').addEventListener('click', () => {
    svg.transition().duration(300).call(zoomBehavior.scaleBy, 1.5);
  });
  document.getElementById('zoomOutBtn').addEventListener('click', () => {
    svg.transition().duration(300).call(zoomBehavior.scaleBy, 0.67);
  });

  // Fullscreen
  document.getElementById('expandBtn').addEventListener('click', toggleFullscreen);
  document.getElementById('fsOverlay').addEventListener('click', toggleFullscreen);

  // Download — native Save As dialog (Chrome/Edge) vs filename popover (Firefox/Safari)
  const dlPop = document.getElementById('dlPop');
  const dlInput = document.getElementById('dlFilename');
  const hasNativeSaveAs = !!window.showSaveFilePicker;
  if (hasNativeSaveAs) document.getElementById('downloadBtn').title = 'Save chart as image (pick folder & filename)';

  document.getElementById('downloadBtn').addEventListener('click', () => {
    if (hasNativeSaveAs) {
      // Chrome/Edge: go straight to OS dialog (handles filename + folder)
      downloadChart(`inequality-${S.baseYear}-${S.finalYear}`);
      return;
    }
    // Firefox/Safari: show popover for filename editing
    const isOpen = !dlPop.classList.contains('hidden');
    if (isOpen) { dlPop.classList.add('hidden'); return; }
    dlInput.value = `inequality-${S.baseYear}-${S.finalYear}`;
    dlPop.classList.remove('hidden');
    dlInput.focus();
    dlInput.select();
  });
  document.getElementById('dlConfirm').addEventListener('click', () => {
    dlPop.classList.add('hidden');
    downloadChart(dlInput.value.trim() || `inequality-${S.baseYear}-${S.finalYear}`);
  });
  dlInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); document.getElementById('dlConfirm').click(); }
    if (e.key === 'Escape') { dlPop.classList.add('hidden'); }
  });
  document.addEventListener('click', e => {
    if (!dlPop.classList.contains('hidden') && !e.target.closest('.dl-wrap')) dlPop.classList.add('hidden');
  });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && document.getElementById('chartWrap').classList.contains('fullscreen')) {
      toggleFullscreen();
    }
  });

  // Mover filters (independent of main chart filters)
  document.getElementById('moverRegionFilter').addEventListener('change', e => {
    moverState.region = e.target.value;
    buildMovers();
    stateToURL();
  });
  document.getElementById('moverIncomeFilter').addEventListener('change', e => {
    moverState.income = e.target.value;
    buildMovers();
    stateToURL();
  });

  let rt;
  window.addEventListener('resize', () => {
    clearTimeout(rt);
    rt = setTimeout(()=>{ measure(); buildChart(); update(); }, 200);
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
